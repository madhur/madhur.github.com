<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>HackingLab Challenge: Disassemble .NET Clients &#8211; Madhur Ahuja</title>
   <meta name="author" content="Madhur Ahuja" />

    <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="atom.xml" title="RSS feed" />
	
   
	<link rel="stylesheet" href="/files/css/global.css" type="text/css" />   
	<link rel="stylesheet" href="/files/css/layout.css" type="text/css" />
	<link rel="stylesheet" href="/files/css/non-blog.css" type="text/css" />
	<link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />
	
	
	
  	<link rel="stylesheet" type="text/css" href="/files/css/blog.css" />
	
	
	<link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css">
   
	<script src="/files/js/jquery.js" type="text/javascript" ></script>
	<script src="/files/js/site.js" type="text/javascript" ></script>

	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-23769089-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
</head>
<body>
<div id="gradient">
	<div id="container">
		<div id="header">

		<div id="logo">
<h2>
	Madhur@Web:~# :(){ :|: &amp; };:

</h2>

</div>


<div id="navigation">
				<ul id="nav">
					<li><a class="home" href="/">Home</a></li>
					<li><a class="blog" href="/blogindex.html">Blog</a></li>
					<!--<li><a class="work" href="/work">Resume</a></li>-->
					<li><a class="code" href="/code">Projects</a></li>
					<li><a class="papers" href="/papers">Papers</a></li>
					<li><a class="info" href="/info">About</a></li>
					<li><a class="contact" href="/contact">Contact</a></li>

				</ul>
				
				
</div>
<div class="c">
&nbsp;
</div>



<!--
<div id="dash">
<div id="intro">

						<p>You're currently viewing the personal website of <a href="/">Madhur</a>, This website is inpired from
						Tom Preston Werner's blog post <a href="http://tom.preston-werner.com/2008/11/17/blogging-like-a-hacker.html">"Blogging like a Hacker"</a>. A huge thanks to him for creating <a href="https://github.com/mojombo/jekyll">Jekyll</a>.</p>
					</div>

					<p id="feed">Subscribe to <a href="/blog/feed">posts</a> or <a href="/blog/comments/feed">comments</a></p>
					<p id="twitter"><a href="http://twitter.com/madhur25" title="tweet tweet!">Follow me on Twitter</a></p>
					<div class="c">&nbsp;</div>

</div>
-->



		</div>
		<div id="content">

		  <div id="primary">

	<div id="blogcontent">

		<div class="postmeta full">

		 <p class="timestamp">10 September 2011

<br>
<span class="time">11:00 PM</span>
</p> 

<div class="actions">
<ul> 
								<li><a href="/blog/2011/09/10/hackchallenge.html#disqus_thread" data-disqus-identifier="/2011/09/10/hackchallenge/" class="comment">View Comments</a></li> 

<script type="text/javascript">

var disqus_developer = 1;
	var disqus_shortname = 'madhur';
	var disqus_iframe_css = "http://madhur.github.com/css/screen.css";
		var links = document.getElementsByTagName('a');
		var query = '?';
		
				query += 'url=' + encodeURIComponent(window.location.href) + '&';
				//alert(query);
			
		
document.write('<script type="text/javascript" src="http://disqus.com/forums/madhur/get_num_replies.js?url2=' + encodeURIComponent(window.location.url) + '#disqus_thread"></' + 'script>');
	

</script>


								<li><span class="share" title="Click to expand">share this post</span> 
									<ul class="sharing" style="display:none"> 
										<li class="first"><a href="http://blinklist.com/index.php?Action=Blink/addblink.php&amp;Url=/blog/2011/09/10/hackchallenge.html&amp;Title=HackingLab Challenge: Disassemble .NET Clients" id="share_blinklist" title="Share on BlinkList" rel="nofollow">BlinkList</a></li> 
										<li><a href="http://del.icio.us/post?url=http://madhur.github.com/blog/2011/09/10/hackchallenge.html&amp;title=HackingLab Challenge: Disassemble .NET Clients" id="share_delicious" title="Add to del.icio.us" rel="nofollow">del.icio.us</a></li> 
										<li><a href="http://digg.com/submit?url=http://madhur.github.com/blog/2011/09/10/hackchallenge.html" id="share_digg" title="Digg This!" rel="nofollow">Digg</a></li> 
										<li><a href="http://www.facebook.com/share.php?u=http://madhur.github.com/blog/2011/09/10/hackchallenge.html" id="share_facebook" title="Share on Facebook" rel="nofollow">Facebook</a></li> 
										<li><a href="http://reddit.com/submit?url=http://madhur.github.com/blog/2011/09/10/hackchallenge.html&amp;title=HackingLab Challenge: Disassemble .NET Clients" id="share_reddit" title="Share on Reddit" rel="nofollow">Reddit</a></li> 
										<li><a href="http://www.stumbleupon.com/submit?url=http://madhur.github.com/blog/2011/09/10/hackchallenge.html&amp;title=HackingLab Challenge: Disassemble .NET Clients" id="share_stumbleupon" title="Share on StumbleUpon" rel="nofollow">StumbleUpon</a></li> 
										<li><a href="http://twitter.com/home?status=http://madhur.github.comHackingLab Challenge: Disassemble .NET Clients%3A%20/blog/2011/09/10/hackchallenge.html" id="share_twitter" title="Tweet this!" rel="nofollow">Twitter</a></li> 
										<li class="last"><a href="http://www.technorati.com/faves?add=http://madhur.github.com/blog/2011/09/10/hackchallenge.html" id="share_technorati" title="Favourite on Technorati" rel="nofollow">Technorati</a></li> 
									</ul> 
								</li> 
								<li><a href="http://feeds.feedburner.com/madhur
" class="subscribe">subscribe to this blog</a></li> 
								
								<li><a href="javascript:Clickheretoprint()" class="subscribe">print this page</a></li> 								
								<li><a href="/blog/2011/09/10/hackchallenge.html" class="permalink">permalink</a></li> 
															</ul> 

</div>

<div class="category">
<h3>Advert</h3>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-1657163894706869";
/* madhur.co.in right side */
google_ad_slot = "3156850124";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>


		</div>

		<div class="post full">
		<h1>HackingLab Challenge: Disassemble .NET Clients</h1>
 <p>Compass Security has come up with a hacking challenge on their <a href='https://www.hacking-lab.com/sh/LAE04Jf'>site</a>. The challenge consist of an .NET client having some hidden functionality which needs to be uncovered by the user. I decided to give it a try.</p>

<h2 id='requirements'>Requirements</h2>

<ul>
<li>Download <a href='http://media.hacking-lab.com/largefiles/7205/DotNetFatClientHacking.exe'>Application: DotNetFatClientHacking.exe</a></li>
</ul>

<h2 id='tools_used_in_the_trade'>Tools used in the trade</h2>

<ul>
<li><a href='http://www.reflector.net/'>Reflector</a> or now better <a href='http://www.jetbrains.com/decompiler/'>DotPeek</a></li>

<li>ILDasm</li>

<li>Hex Editor</li>

<li>MSDN</li>
</ul>

<h2 id='solution'>Solution</h2>

<p>Let&#8217;s run our .NET assembly and see what it looks like. Its a normal Windows Form application with just one button which does nothing. I could not figure out anything else from the application.</p>

<p><img alt='' src='/images/netapp.png' /></p>

<p>Let&#8217;s open the assembly in Reflector and see what it&#8217;s doing.</p>

<p><img alt='' src='/images/reflector.png' /></p>

<p>From the reflector, I could figure out the following</p>

<ul>
<li>The form has got actually 3 buttons, 2 are hidden</li>

<li>There is a <em>BusinessClass</em> class in the assembly which is invoked by the hidden buttons</li>

<li>The visible button checks if the user is <em>Admin</em> and hides or shows the other two buttons</li>
</ul>

<p>Now, our job is to become the Admin :) . That&#8217;s the code which is called by the Visible button <strong>Identify me</strong></p>
<div class='highlight'><pre><code class='csharp'> <span class='k'>private</span> <span class='k'>void</span> <span class='nf'>identifyUser</span><span class='p'>()</span>
    <span class='p'>{</span>
      <span class='k'>if</span> <span class='p'>(</span><span class='k'>this</span><span class='p'>.</span><span class='n'>IsAdmin</span><span class='p'>())</span>
      <span class='p'>{</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>labUser</span><span class='p'>.</span><span class='n'>Text</span> <span class='p'>=</span> <span class='s'>&quot;Welcome Admin!&quot;</span><span class='p'>;</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>butAdminHTTP</span><span class='p'>.</span><span class='n'>Visible</span> <span class='p'>=</span> <span class='k'>true</span><span class='p'>;</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>butAdminHTTPS</span><span class='p'>.</span><span class='n'>Visible</span> <span class='p'>=</span> <span class='k'>true</span><span class='p'>;</span>
      <span class='p'>}</span>
      <span class='k'>else</span>
      <span class='p'>{</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>labUser</span><span class='p'>.</span><span class='n'>Text</span> <span class='p'>=</span> <span class='s'>&quot;Welcome User!&quot;</span><span class='p'>;</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>butAdminHTTP</span><span class='p'>.</span><span class='n'>Visible</span> <span class='p'>=</span> <span class='k'>false</span><span class='p'>;</span>
        <span class='k'>this</span><span class='p'>.</span><span class='n'>butAdminHTTPS</span><span class='p'>.</span><span class='n'>Visible</span> <span class='p'>=</span> <span class='k'>false</span><span class='p'>;</span>
      <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre>
</div>
<p>Clearly, our main interest is in <em>IsAdmin()</em> function which is defined as follows:</p>
<div class='highlight'><pre><code class='csharp'><span class='k'>private</span> <span class='kt'>bool</span> <span class='nf'>IsAdmin</span><span class='p'>()</span>
    <span class='p'>{</span>
      <span class='k'>foreach</span> <span class='p'>(</span><span class='kt'>object</span> <span class='n'>obj</span> <span class='k'>in</span> <span class='n'>Dns</span><span class='p'>.</span><span class='n'>GetHostEntry</span><span class='p'>(</span><span class='n'>Dns</span><span class='p'>.</span><span class='n'>GetHostName</span><span class='p'>()).</span><span class='n'>AddressList</span><span class='p'>)</span>
      <span class='p'>{</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='n'>obj</span><span class='p'>.</span><span class='n'>ToString</span><span class='p'>().</span><span class='n'>Equals</span><span class='p'>(</span><span class='s'>&quot;258.54.54.699&quot;</span><span class='p'>))</span>
          <span class='k'>return</span> <span class='k'>true</span><span class='p'>;</span>
      <span class='p'>}</span>
      <span class='k'>return</span> <span class='k'>false</span><span class='p'>;</span>
    <span class='p'>}</span>	
</code></pre>
</div>
<p>Hmmm. Very Interesting !!! Do you understand what is it doing ?</p>

<p>It basically retrieving the host name of our computer and based on that hostname getting all the IP addresses assigned to the network interfaces present in the system. If any of its IP address matches <em>258.54.54.699</em>, I am the Admin :).</p>

<p>Now the interesting part here is that <em>258.54.54.699</em> is actually an invalid IP address otherwise I could have fooled the program by temporarily assigning this IP address to either one of my interfaces or even write that in <em>hosts</em> file.</p>

<p>But since its invalid IP, it will never be returned by system API. So, we must patch the program.</p>

<p>Let&#8217;s open the function in <em>ILDASM</em> and look at its disassembly.</p>
<div class='highlight'><pre><code class='text'>  IL_001c:  ldloc.1
  IL_001d:  callvirt   instance string [mscorlib]System.Object::ToString()
  IL_0022:  ldstr      &quot;258.54.54.699&quot;
  IL_0027:  callvirt   instance bool [mscorlib]System.String::Equals(string)
  IL_002c:  brfalse.s  IL_0032
  IL_002e:  ldc.i4.1
</code></pre>
</div>
<p>There are several ways to do it. I will write down from tedious to easiest</p>

<ul>
<li>Export the classes from Reflector to Visual Studio solution and change the IP address to our actual IP address. But then Why not just NOP out the call itself :). This requires boring effort</li>

<li>Use the ILASM or any other utility to change the instruction at <em>ldstr &#8220;258.54.54.699&#8221;</em> to <em>ldstr actual ip</em>. Even this requires some effort</li>

<li>Easiest Way: Actually we can just take advantage of if-else branch reversal.</li>
</ul>

<p>Let&#8217;s take a look at disassembly of <em>identifyuser()</em> function</p>

<p><img alt='' src='/images/ildasm-output.png' /></p>

<p>If you closely look at the disassembly above, the instruction at IL_0006 is doing all the magic which is</p>
<div class='highlight'><pre><code class='text'>  IL_0006:  /* 2C   | 29               */ brfalse.s  IL_0031
</code></pre>
</div>
<p>What this instruction means is that if output of <em>IsAdmin()</em> is false, branch to instruction at IL_0031, the instruction which hides the buttons. Now, we can just change this instruction to reverse, i.e. make it <strong>brtrue.s</strong>. A quick look at <a href='http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.brtrue_s\(v=vs.71\'>MSDN</a>.aspx) tells me that its opcode is 2D as opposed to 2C which stands for <strong>brfalse.s</strong>.</p>

<p>Now, we just need to fire up the favourite hex editor and <strong>change just one byte.</strong> from 2C to 2D.</p>
<div class='highlight'><pre><code class='text'>Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F

000005A0  02 28 02 00 00 06 02 28 05 00 00 06 2A 1E 02 28  
000005B0  05 00 00 06 2A 00 00 00 03 30 02 00 5A 00 00 00  
000005C0  00 00 00 00 02 28 06 00 00 06 2D 29 02 7B 02 00  
000005D0  00 04 72 F5 00 00 70 6F 1E 00 00 0A 02 7B 04 00  
</code></pre>
</div>
<p>Our target lies at offset 5CA which I have already flipped from 2C to 2D as shown above. Let&#8217;s save the file and run it again.</p>

<p><img alt='' src='/images/cracked.png' /></p>

<p>Voilla !!! The Administrative buttons are visible and clicking them invokes the Business functions which fetch some HTML output over the internet :)</p>

<div class="blocked tags">
<p>

	<a href="/categories/Hacking.html">Hacking</a> |

	<a href="/categories/Disassembling.html">Disassembling</a> |

	<a href="/categories/.NET.html">.NET</a> |

</p>
</div>
<div class="hr"></div>

<div>

<!-- Place this tag where you want the +1 button to render -->
<div class="social">
<g:plusone></g:plusone>
<fb:like href="http://madhur.github.com/blog/2011/09/10/hackchallenge.html" send="true" layout="button_count" width="450" show_faces="true" colorscheme="dark" font="lucida grande"></fb:like>
</div>


<!-- Place this tag after the last plusone tag -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<div id="fb-root"></div>
<script>
window.fbAsyncInit = function() {
FB.init({appId: 'your app id', status: true, cookie: true,
xfbml: true});
};

(function() {
var e = document.createElement('script'); e.async = true;
e.src = document.location.protocol +
'//connect.facebook.net/en_US/all.js';
document.getElementById('fb-root').appendChild(e);
}());
</script>

</div>


<!-- Discus Comments -->
<div id="disqus_thread"></div>


<!-- Enable Disqus comments -->
<script type="text/javascript">
  var disqus_shortname = 'madhur';
  var disqus_identifier = '/2011/09/10/hackchallenge/';
  var disqus_title = 'HackingLab Challenge: Disassemble .NET Clients';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


		</div>

		<div class="c">&nbsp;</div>

	</div>

	
</div>
 
<div class="c">&nbsp;</div>


  
<script type="text/javascript">
    
    var disqus_shortname = 'madhur'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

 

 



		</div>
		  
		  <div id="footer">
			
				<p id="copyright">
					Content &amp; Design by 
					<a href="/info/">Madhur Ahuja</a>
					&copy; 2010-2011
					(Some rights reserved)			
				</p>
				<p id="poweredby">
					Powered by 
					<a href="https://github.com/mojombo/jekyll" title="A static, minimalist CMS">Jekyll</a> and <a href="http://disqus.com">Disqus</a>.
				</p>

				<div class="c">&nbsp;</div>

			
		  </div>

	</div>

</div>


<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
