<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" /> 
    <title>Incrementally routing traffic to newer version of service &#8211; Madhur Ahuja</title>
    

    <meta name="author" content="Madhur Ahuja" />
    <meta name="description" content=" Incrementally routing traffic to newer version of service" />

    <link rel="start" href="/" />

    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />

    <link rel="stylesheet" href="/files/css/bootstrap.min.css" type="text/css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
    <script src="/files/js/vendor/fancybox.umd.js" tpye="text/javascript"></script>
    <link rel="stylesheet" href="/files/css/fancybox.css" type="text/css" />

    <link rel="stylesheet" type="text/css" href="/files/css/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/files/css/syntax.css" /> 

     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N14VDHYFHQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N14VDHYFHQ');
</script> 
    <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css"> 

    <script src="/files/js/vendor/pace.min.js" type="text/javascript"></script>
</head>


<body>

    <div class="container">

        <header id="header" class="row">

            <nav id="navigation" class="navbar navbar-inverse navbar-fixed-top top-nav-collapse" role="navigation">
    <div class="container">

        <div class="navbar-header">

            <div class="hidden-md hidden-sm hidden-lg searchli">

                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q2" name="q" value="" class="form-control mobile"
                            placeholder="Search" />
                    </div>
                </form>
            </div>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mainmenu">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--  <a class="navbar-brand " href="/">Home</a> -->
        </div>

        <div class="collapse navbar-collapse" id="mainmenu">
            <ul id="nav" class="nav navbar-nav">

                <li><a class="home" href="/">Home</a>
                </li>
                <li><a class="blog" href="/blog">Blog</a>
                </li>
                <!--<li><a class="work" href="/work">Resume</a></li>-->
                <li><a class="code" href="/projects">Work</a>
                </li>
                <!--<li><a class="papers" href="/papers">Papers</a></li>-->
                <li><a class="info" href="/info">About</a>
                </li>
                <li><a class="contact" href="/contact">Contact</a>
                </li>

            </ul>

            <ul class="nav navbar-nav visible-md visible-lg visible-sm searchbox">
                <li>
                    <form method="get" role="search" id="searchform" action="/results"
                        onsubmit="return checkfrm_search();">

                        <div class="form-group">
                            <input type="search" required id="q1" name="q" value="" class="form-control desktop"
                                placeholder="Search" />
                        </div>
                    </form>
                </li>
            </ul>


            <ul class="nav-icons navbar-right nav navbar-nav visible-md visible-lg">
                <li><a href="http://www.linkedin.com/in/madhurahuja"><i class="fa fa-linkedin-square fa-3x"></i></a>
                </li>
                <li><a href="https://github.com/madhur"><i class="fa fa-github fa-3x"></i></a>
                </li>
                <li><a href="http://feeds.feedburner.com/madhur"><i class="fa fa-rss-square fa-3x"></i></a>
                </li>
            </ul>


        </div>

    </div>
</nav>

        </header>

        <div id="content" class="row">

            <section>

	<div id="blogcontent">


		<article id="blog-article" class="post col-md-12 clearfix">

			<header>
				<h1>Incrementally routing traffic to newer version of service</h1>
			</header>

			



<div class="post-meta">
    <time datetime="2020-02-08T00:00:00+05:30">February 08, 2020</time>
    <span class="reading-time">1 min read</span>
</div>


			<hr style="margin-top:0px" />


			<p>Recently, I had a requirement to incrementally increase the traffic to a newer version of service we were deploying in production.</p>

<p>We didn’t wanted to go with random percentage approach. This is because our users are mobile app users and we didn’t want the users to hit the older version and newer version of service randomly.</p>

<p>That is, we wanted to consistently map the user to either be routed to an older version of newer version based on certain configurable percentage.</p>

<p><a href="/images/hash.png">Open diagram in fullscren</a></p>

<p><img src="/images/hash.png" height="500px" width="852px" /></p>

<p>Our proxy server was based on node.js</p>

<p>After evaluating several algorithms to generate hash based on user id, such as <a href="https://en.wikipedia.org/wiki/Base64">Base64</a>, <a href="https://en.wikipedia.org/wiki/MD5">MD5</a>. I finally zeroed out on <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC32 algorithm</a>.</p>

<p>The simple reason being that output of CRC32 is a simple 32 bit integer which can be easily converted to a percentage value and the performance of crc32 being the fastest among all.</p>

<p>The simple methods below give the gist of algorithm. Our <code class="language-plaintext highlighter-rouge">getHash</code> function generates the 32 bit integer and <code class="language-plaintext highlighter-rouge">routeRequestBasedonRampUp</code> method uses this integer to map it to 1..100 buckets. Based on the rampup percentage value, it gives a boolean response which is used by proxy layer.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getHash</span> <span class="o">=</span> <span class="nx">userId</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">CRC32</span><span class="p">.</span><span class="nx">str</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">routeRequestBasedonRampUp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">rampUpPercent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">NUM_BUCKETS</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
  
  <span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">getHash</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">hash</span> <span class="o">%</span> <span class="nx">NUM_BUCKETS</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span><span class="nx">bucket</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nx">rampUpPercent</span><span class="p">);</span> 
<span class="p">};</span>
</code></pre></div></div>

<p>I have used this approach in production with this <a href="https://www.npmjs.com/package/crc-32">crc32 library</a></p>

<p>The decisioning time is &lt;1ms and have been serving us really well.</p>

<p>Please let me know in the comments section if you think any better approach is available.</p>

			<footer>
				<div class="blocked tags">
					<p>
						
						<a href="/blog/tags/hashing">Hashing</a> |
						
						<a href="/blog/tags/node-js">Node.js</a> |
						
					</p>
				</div>
			</footer>

			<br />



			<div class="hr"></div>

		</article>

		<div class="c">&nbsp;</div>

	</div>


</section>

<div class="c">&nbsp;</div>

        </div>


        <footer id="footer" class="row">

            <p id="copyright">
                &copy; 2011-2026 Madhur Ahuja
            </p>
            <p id="poweredby" class="visible-lg visible-md">
                Powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://github.com/">Github</a>.
            </p>

            <div class="c">&nbsp;</div>


        </footer>


    </div>

    <script data-main="/files/js/app" src="/files/js/require.js"></script> 
    

    <!-- serviceWorker.html -->
    <script>
        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister()
                }
            })
        }

// if ('serviceWorker' in navigator) {
//     navigator.serviceWorker.register('/serviceWorker.js').then(function(reg) {
//         if (!reg.installing) return;
//         console.log("[*] ServiceWorker is installing...");

//         var worker = reg.installing;
//         worker.addEventListener('statechange', function() {
//             if (worker.state == 'redundant') {
//                 console.log('[*] Install failed');
//             }
//             if (worker.state == 'installed') {
//                 console.log('[*] Install successful!');
//             }
//         });
//     });
// }

    </script>

</body>

</html>