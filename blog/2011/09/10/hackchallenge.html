<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    
        <title>HackingLab Challenge: Disassemble .NET Clients &#8211; Madhur Ahuja</title>
    

    <meta name="author" content="Madhur Ahuja" />
    <meta name="description" content=" HackingLab Challenge: Disassemble .NET Clients" />

    <link rel="start" href="/" />

    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />

    <link rel="stylesheet" href="/files/css/bootstrap.min.css" type="text/css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="/files/css/jquery.fancybox.css" type="text/css" />

    <link rel="stylesheet" type="text/css" href="/files/css/styles.css" />
    
    
    <link rel="stylesheet" type="text/css" href="/files/css/syntax.css" />
    

    <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css">

     
   
    <script src="/files/js/vendor/pace.min.js" type="text/javascript"></script>
</head>

<body>

    <div class="container">
       
            <header id="header" class="row">

                <nav id="navigation" class="navbar navbar-inverse navbar-fixed-top " role="navigation">
    <div class="container">

    <div class="navbar-header">

     <div class="hidden-md hidden-sm hidden-lg searchli">

                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q2" name="q" value="" class="form-control mobile" placeholder="Search" />
                    </div>
                </form>
        </div>

        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mainmenu">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <!--  <a class="navbar-brand " href="/">Home</a> -->
    </div>

    <div class="collapse navbar-collapse" id="mainmenu">
        <ul id="nav" class="nav navbar-nav">
            
            <li><a class="home" href="/">Home</a>
            </li>
            <li><a class="blog" href="/blog">Blog</a>
            </li>
            <!--<li><a class="work" href="/work">Resume</a></li>-->
            <li><a class="code" href="/projects">Work</a>
            </li>
            <!--<li><a class="papers" href="/papers">Papers</a></li>-->
            <li><a class="info" href="/info">About</a>
            </li>
            <li><a class="contact" href="/contact">Contact</a>
            </li>

        </ul>

        <ul class="nav navbar-nav visible-md visible-lg visible-sm searchbox">
            <li>
                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q1" name="q" value="" class="form-control desktop" placeholder="Search" />
                    </div>
                </form>
            </li>
        </ul>


        <ul class="nav-icons navbar-right nav navbar-nav visible-md visible-lg">
            <li><a href="http://www.linkedin.com/in/madhurahuja"><i class="fa fa-linkedin-square fa-3x"></i></a>
            </li>
            <li><a href="https://github.com/madhur"><i class="fa fa-github fa-3x"></i></a>
            </li>
            <li><a href="http://feeds.feedburner.com/madhur"><i class="fa fa-rss-square fa-3x"></i></a>
            </li>
        </ul>


    </div>

</div>
</nav>


            </header>
       
        <div id="content" class="row">

            <section>

	<div id="blogcontent">

		<!--<aside class="postmeta col-md-3 hidden-print visible-md visible-lg">

			

		</aside>-->

		<article id="blog-article" class="post col-md-12 clearfix">

				<header><h1>HackingLab Challenge: Disassemble .NET Clients</h1></header>
			
					<!-- Place this tag where you want the +1 button to render -->
<div class="row social hidden-xs">
	<div class="col-md-2 col-sm-2">
		<time datetime="2011-09-10 00:00:00 +0530" pubdate="pubdate">10 September 2011</time>
	</div>
    <div class="social-icon col-md-1 col-sm-1">
        <div class="g-plusone" data-size="small"></div>
    </div>
    <div class="social-icon col-md-1 col-sm-2">
        <a href="https://twitter.com/share?count=vertical" class="twitter-share-button" data-via="madhur25">Tweet</a>
        <script>
        ! function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0],
                p = /^http:/.test(d.location) ? 'http' : 'https';
            if (!d.getElementById(id)) {
                js = d.createElement(s);
                js.id = id;
                js.src = p + '://platform.twitter.com/widgets.js';
                fjs.parentNode.insertBefore(js, fjs);
            }
        }(document, 'script', 'twitter-wjs');
        </script>
    </div>
    <div class="social-icon col-md-1 col-sm-2">
        <script src="//platform.linkedin.com/in.js" type="text/javascript">
        lang: en_US
        </script>
        <script type="IN/Share" data-counter="right"></script>
    </div>

    <div class="social-icon col-md-1 col-sm-2">
        <a href="http://bufferapp.com/add" class="buffer-add-button" data-count="horizontal">Buffer</a>
        <script type="text/javascript" src="https://d389zggrogs7qo.cloudfront.net/js/button.js"></script>
    </div>
    <div class="social-icon col-md-1 col-sm-2">
        <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
        <script type="text/javascript">
        ! function(d, i) {
            if (!d.getElementById(i)) {
                var j = d.createElement("script");
                j.id = i;
                j.src = "https://widgets.getpocket.com/v1/j/btn.js?v=1";
                var w = d.getElementById(i);
                d.body.appendChild(j);
            }
        }(document, "pocket-btn-js");
        </script>
    </div>
				<div class="social-icon col-md-2 col-sm-2">
<script type="text/javascript" src="//www.redditstatic.com/button/button1.js"></script>
				</div>

	
</div>
<!-- Place this tag after the last plusone tag -->
<!-- Place this tag after the last +1 button tag. -->
<script type="text/javascript">
(function() {
    var po = document.createElement('script');
    po.type = 'text/javascript';
    po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(po, s);
})();
</script>


			<hr style="margin-top:0px" />


			 <p>Compass Security has come up with a hacking challenge on their <a href="https://www.hacking-lab.com/sh/LAE04Jf">site</a>. The challenge consist of an .NET client having some hidden functionality which needs to be uncovered by the user. I decided to give it a try.</p>

<h2>Requirements</h2>

<ul>
<li>Download  <a href="http://media.hacking-lab.com/largefiles/7205/DotNetFatClientHacking.exe">Application: DotNetFatClientHacking.exe</a></li>
</ul>

<h2>Tools used in the trade</h2>

<ul>
<li><a href="http://www.reflector.net/">Reflector</a> or now better <a href="http://www.jetbrains.com/decompiler/">DotPeek</a></li>
<li>ILDasm</li>
<li>Hex Editor</li>
<li>MSDN</li>
</ul>

<h2>Solution</h2>

<p>Let&#39;s run our .NET assembly and see what it looks like. Its a normal Windows Form application with just one button which does nothing. I could not figure out anything else from the application.</p>

<p><img src="/images/netapp.png" alt=""></p>

<p>Let&#39;s open the assembly in Reflector and see what it&#39;s doing. </p>

<p><img src="/images/reflector.png" alt=""></p>

<p>From the reflector, I could figure out the following</p>

<ul>
<li>The form has got actually 3 buttons, 2 are hidden</li>
<li>There is a <em>BusinessClass</em> class in the assembly which is invoked by the hidden buttons</li>
<li>The visible button checks if the user is <em>Admin</em> and hides or shows the other two buttons</li>
</ul>

<p>Now, our job is to become the Admin :) . That&#39;s the code which is called by the Visible button <strong>Identify me</strong></p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"> <span class="k">private</span> <span class="k">void</span> <span class="nf">identifyUser</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">IsAdmin</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">labUser</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"Welcome Admin!"</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">butAdminHTTP</span><span class="p">.</span><span class="n">Visible</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">butAdminHTTPS</span><span class="p">.</span><span class="n">Visible</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">labUser</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="s">"Welcome User!"</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">butAdminHTTP</span><span class="p">.</span><span class="n">Visible</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">butAdminHTTPS</span><span class="p">.</span><span class="n">Visible</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>Clearly, our main interest is in <em>IsAdmin()</em> function which is defined as follows:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsAdmin</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="kt">object</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">Dns</span><span class="p">.</span><span class="nf">GetHostEntry</span><span class="p">(</span><span class="n">Dns</span><span class="p">.</span><span class="nf">GetHostName</span><span class="p">()).</span><span class="n">AddressList</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="nf">ToString</span><span class="p">().</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"258.54.54.699"</span><span class="p">))</span>
          <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>    </code></pre></figure>

<p>Hmmm. Very Interesting !!!  Do you understand what is it doing ?</p>

<p>It basically retrieving the host name of our computer and based on that hostname getting all the IP addresses assigned to the network interfaces present in the system.
If any of its IP address matches <em>258.54.54.699</em>, I am the Admin :).</p>

<p>Now the interesting part here is that <em>258.54.54.699</em> is actually an invalid IP address otherwise I could have fooled the program by temporarily assigning this IP address to either one of my interfaces or even write that in <em>hosts</em> file.</p>

<p>But since its invalid IP, it will never be returned by system API. So, we must patch the program.</p>

<p>Let&#39;s open the function in <em>ILDASM</em> and look at its disassembly.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  IL_001c:  ldloc.1
  IL_001d:  callvirt   instance string [mscorlib]System.Object::ToString()
  IL_0022:  ldstr      "258.54.54.699"
  IL_0027:  callvirt   instance bool [mscorlib]System.String::Equals(string)
  IL_002c:  brfalse.s  IL_0032
  IL_002e:  ldc.i4.1</code></pre></figure>
  

<p>There are several ways to do it. I will write down from tedious to easiest</p>

<ul>
<li>Export the classes from Reflector to Visual Studio solution and change the IP address to our actual IP address. But then Why not just NOP out the call itself :). This requires boring effort</li>
<li>Use the ILASM or any other utility to change the instruction at <em>ldstr      &quot;258.54.54.699&quot;</em> to <em>ldstr actual ip</em>. Even this requires some effort</li>
<li>Easiest Way: Actually we can just take advantage of if-else branch reversal.</li>
</ul>

<p>Let&#39;s take a look at disassembly of <em>identifyuser()</em> function</p>

<p><img src="/images/ildasm-output.png" alt=""></p>

<p>If you closely look at the disassembly above,  the instruction at IL_0006 is doing all the magic which is </p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  IL_0006:  /* 2C   | 29               */ brfalse.s  IL_0031</code></pre></figure>
  

<p>What this instruction means is that if output of <em>IsAdmin()</em> is false, branch to instruction at IL_0031, the instruction which hides the buttons.
Now, we can just change this instruction to reverse, i.e. make it <strong>brtrue.s</strong>. A quick look at MSDN tells me that its opcode is 2D as opposed to 2C which stands for <strong>brfalse.s</strong>.</p>

<p>Now, we just need to fire up the favourite hex editor and <strong>change just one byte.</strong> from 2C to 2D.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F

000005A0  02 28 02 00 00 06 02 28 05 00 00 06 2A 1E 02 28  
000005B0  05 00 00 06 2A 00 00 00 03 30 02 00 5A 00 00 00  
000005C0  00 00 00 00 02 28 06 00 00 06 2D 29 02 7B 02 00  
000005D0  00 04 72 F5 00 00 70 6F 1E 00 00 0A 02 7B 04 00  </code></pre></figure>
  

<p>Our target lies at offset 5CA which I have already flipped from 2C to 2D as shown above. Let&#39;s save the file and run it again.</p>

<p><img src="/images/cracked.png" alt=""></p>

<p>Voilla !!! The Administrative buttons are visible and clicking them invokes the Business functions which fetch some HTML output over the internet :)</p>

			<footer>
				<div class="blocked tags">
					<p>
					
						<a href="/blog/tags/hacking">Hacking</a> |
					
						<a href="/blog/tags/disassembling">Disassembling</a> |
					
						<a href="/blog/tags/net">.NET</a> |
					
					</p>
				</div>
			</footer>
			
			<br/>
		
			
			
			<div class="hr"></div>

		


			<!-- Discus Comments -->
			<div id="disqus_thread"></div>

			
			<!-- Enable Disqus comments -->
			<script type="text/javascript">
  var disqus_developer = 0; // developer mode is on
  var disqus_shortname = 'madhur';
  var disqus_identifier = '/2011/09/10/hackchallenge/';
  var disqus_title = 'HackingLab Challenge: Disassemble .NET Clients';
  var disqus_url = 'http://madhur.co.in/blog/2011/09/10/hackchallenge.html';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

</script>

			
			
			
			

		</article>

		<div class="c">&nbsp;</div>

	</div>

	
</section>
 
<div class="c">&nbsp;</div>


  
<script type="text/javascript">
    
    var disqus_shortname = 'madhur'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

 

 



        </div>


        <footer id="footer" class="row">

            <p id="copyright">
                &copy; 2011-2017 Madhur Ahuja
            </p>
            <p id="poweredby" class="visible-lg visible-md">
                Powered by
                <a href="http://jekyllrb.com" title="A static, minimalist CMS">Jekyll</a>, <a href="http://github.com/">Github</a> and <a href="http://disqus.com">Disqus</a>.
            </p>

            <div class="c">&nbsp;</div>


        </footer>


    </div>

    <script data-main="/files/js/app" src="/files/js/require.js"></script>

    
        <script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-23769089-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
    

    <!-- serviceWorker.html -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/serviceWorker.js').then(function(reg) {
        if (!reg.installing) return;
        console.log("[*] ServiceWorker is installing...");

        var worker = reg.installing;
        worker.addEventListener('statechange', function() {
            if (worker.state == 'redundant') {
                console.log('[*] Install failed');
            }
            if (worker.state == 'installed') {
                console.log('[*] Install successful!');
            }
        });
    });
}

</script>

</body>

</html>
