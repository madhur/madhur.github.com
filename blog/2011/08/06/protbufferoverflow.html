<!DOCTYPE html>

<html lang="en">
<head>
   <meta charset="utf-8" />
   <title>Protections against buffer overflow exploits in Linux &#8211; Madhur Ahuja</title>
   <meta name="author" content="Madhur Ahuja" />
   
    
		<meta name="description" content=" Protections against buffer overflow exploits in Linux" />
	

    <link rel="start" href="/" />

	
	
  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
	<link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />
   
	<link rel="stylesheet" href="/files/css/blueprint/screen.css" type="text/css" />   	
	<!--<link rel="stylesheet" href="/files/css/disqus-form.css" type="text/css" /> -->
	
	<!--<link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />-->
	<link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
	<link rel="stylesheet" href="/files/css/jquery.fancybox.css" type="text/css" />
	
	<link rel="stylesheet" type="text/css" href="/files/css/styles.css" />
	
	
		<link rel="stylesheet" type="text/css" href="/files/css/syntax.css" />
	
			
   <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css">
   
   
	<script src="/files/js/jquery.js" type="text/javascript"></script>	
	<script src="/files/js/jquery.fancybox.pack.js" type="text/javascript"></script>
	
	<!--[if lt IE 9]>
		<script src="/files/js/modernizr-2.5.3.js" type="text/javascript"></script>
	<![endif]-->
	
	<script type="text/javascript">
	var disqus_iframe_css = 'http://madhur.co.in/files/css/disqus-form.css';
	</script>
	
	
	<script src="/files/js/URI.js" type="text/javascript"></script>
	<script src="/files/js/site.js" type="text/javascript"></script>
	
	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-23769089-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
		
	
</head>
<body>
<div id="gradient">
	<div id="container" class="container">
		<header id="header" class="span-24 last">

			<div id="logo">
<ul>
<li><a href="http://www.linkedin.com/in/madhurahuja"><img src="/images/linkedinhigh.png" /></a></li>
<li><a href="https://github.com/madhur"><img src="/images/github_32.png"/></a></li>
<li><a href="http://feeds.feedburner.com/madhur"><img src="/images/rsshigh.png" /></a></li>
</ul>
</div>


<nav id="navigation">
				<ul id="nav">
					<li><a class="madhur" href="/">Madhur Ahuja</a></li>
					<li><a class="home" href="/">Home</a></li>
					<li><a class="blog" href="/blogindex.html">Blog</a></li>
					<!--<li><a class="work" href="/work">Resume</a></li>-->
					<li><a class="code" href="/projects">Projects</a></li>
					<li><a class="papers" href="/papers">Papers</a></li>
					<li><a class="info" href="/info">About</a></li>
					<li><a class="contact" href="/contact">Contact</a></li>

				</ul>
				
				
</nav>
<div class="c">
&nbsp;
</div>



		</header>
		<div id="content" class="span-24 last">

			<section id="primary" class="span-24 last">

	<div id="blogcontent">

		<aside class="postmeta full span-5">

			<div class="timestamp">
	<time datetime="2011-08-06 00:00:00 +0530" pubdate="pubdate">06 August 2011</time>

	<br>
	<span pubdate="pubdate" class="time">11:00 AM</span>
</div> 

<div class="actions">
<ul> 
								<li><a href="/blog/2011/08/06/protbufferoverflow.html#disqus_thread" data-disqus-identifier="/2011/08/06/protbufferoverflow/" class="comment">View Comments</a></li> 

<script type="text/javascript">

	var disqus_developer = 0;
		var disqus_shortname = 'madhur';
		var disqus_iframe_css = "http://madhur.github.com/css/screen.css";
			var links = document.getElementsByTagName('a');
			var query = '?';
			
					query += 'url=' + encodeURIComponent(window.location.href) + '&';
					//alert(query);
				
			
	document.write('<script type="text/javascript" src="http://disqus.com/forums/madhur/get_num_replies.js?url2=' + encodeURIComponent(window.location.url) + '#disqus_thread"></' + 'script>');
	

</script>


								<li><span class="share" title="Click to expand">share this post</span> 
									<ul class="sharing" style="display:none"> 
										<li class="first"><a href="http://blinklist.com/index.php?Action=Blink/addblink.php&amp;Url=/blog/2011/08/06/protbufferoverflow.html&amp;Title=Protections against buffer overflow exploits in Linux" id="share_blinklist" title="Share on BlinkList" rel="nofollow">BlinkList</a></li> 
										<li><a href="http://del.icio.us/post?url=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html&amp;title=Protections against buffer overflow exploits in Linux" id="share_delicious" title="Add to del.icio.us" rel="nofollow">del.icio.us</a></li> 
										<li><a href="http://digg.com/submit?url=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html" id="share_digg" title="Digg This!" rel="nofollow">Digg</a></li> 
										<li><a href="http://www.facebook.com/share.php?u=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html" id="share_facebook" title="Share on Facebook" rel="nofollow">Facebook</a></li> 
										<li><a href="http://reddit.com/submit?url=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html&amp;title=Protections against buffer overflow exploits in Linux" id="share_reddit" title="Share on Reddit" rel="nofollow">Reddit</a></li> 
										<li><a href="http://www.stumbleupon.com/submit?url=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html&amp;title=Protections against buffer overflow exploits in Linux" id="share_stumbleupon" title="Share on StumbleUpon" rel="nofollow">StumbleUpon</a></li> 
										<li><a href="http://twitter.com/home?status=http://madhur.co.inProtections against buffer overflow exploits in Linux%3A%20/blog/2011/08/06/protbufferoverflow.html" id="share_twitter" title="Tweet this!" rel="nofollow">Twitter</a></li> 
										<li class="last"><a href="http://www.technorati.com/faves?add=http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html" id="share_technorati" title="Favourite on Technorati" rel="nofollow">Technorati</a></li> 
									</ul> 
								</li> 
								<li><a href="http://feeds.feedburner.com/madhur" class="subscribe">subscribe to this blog</a></li> 
								
								<li><a href="javascript:Clickheretoprint()" class="subscribe">print this page</a></li> 								
								<li><a href="/blog/2011/08/06/protbufferoverflow.html" class="permalink">permalink</a></li> 
															</ul> 

</div>

<div class="category">
<h3>Advert</h3>
	<script type="text/javascript"><!--
google_ad_client = "ca-pub-1657163894706869";
/* madhur.co.in right side */
google_ad_slot = "3156850124";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>


</div>


		</aside>

		<article class="post full span-18 last">
					<header><h1>Protections against buffer overflow exploits in Linux</h1></header>
			 <p>Linux has several inbuilt protection mechanisms to deal with malicious buffer overflow attacks. Some of them are built into kernel while some of them are part of compiler tools such as gcc, g++.</p>

<ul>
<li>Address space Layout Randomization (Kernel)</li>

<li>Executable Stack Protection (Compiler)</li>

<li>Stack smashing protection (Compiler)</li>

<li>Position Independent Executables (Compiler)</li>

<li>Fortify Source (Compiler)</li>

<li>Stack Protector (Compiler)</li>
</ul>

<p><strong><a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">Address Space Randomization</a></strong> is a technique in which various parts of executable such as data, stack and code are randomly given start addresses whenever a program starts. This makes difficult for an attacker to guess let’s stay the base of stack in order for him to successfully launch the buffer overflow attack. ASLR can be disabled in linux with the following command</p>
<div class='highlight'><pre><code class='text'>madhur@bt:~/buffer$ sudo echo 0 &gt; /proc/sys/kernel/randomize_va_space
</code></pre></div>
<p>To reneable just echo it with a positive integer, for ex</p>
<div class='highlight'><pre><code class='text'>madhur@bt:~/buffer$ sudo echo 2 &gt; /proc/sys/kernel/randomize_va_space
</code></pre></div>
<p><strong><a href="http://en.wikipedia.org/wiki/Executable_space_protection">Executable Stack Protection</a></strong> is another technique of preventing buffer overflow attacks. As a result of this protection, the stack portion of the memory is marked non executable. To check if the stack is executable or not, run the following command</p>
<div class='highlight'><pre><code class='text'>madhur@bt:~/buffer$ readelf -l &lt;filename&gt;

Elf file type is EXEC (Executable file)
Entry point 0x8048330
There are 8 program headers, starting at offset 52

Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  PHDR           0x000034 0x08048034 0x08048034 0x00100 0x00100 R E 0x4
  INTERP         0x000134 0x08048134 0x08048134 0x00013 0x00013 R   0x1
      [Requesting program interpreter: /lib/ld-linux.so.2]
  LOAD           0x000000 0x08048000 0x08048000 0x004e4 0x004e4 R E 0x1000
  LOAD           0x000f0c 0x08049f0c 0x08049f0c 0x00108 0x00110 RW  0x1000
  DYNAMIC        0x000f20 0x08049f20 0x08049f20 0x000d0 0x000d0 RW  0x4
  NOTE           0x000148 0x08048148 0x08048148 0x00044 0x00044 R   0x4
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4
  GNU_RELRO      0x000f0c 0x08049f0c 0x08049f0c 0x000f4 0x000f4 R   0x1

 Section to Segment mapping:
  Segment Sections...
   00     
   01     .interp 
   02     .interp .note.ABI-tag .note.gnu.build-id .hash .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .text .fini .rodata .eh_frame 
   03     .ctors .dtors .jcr .dynamic .got .got.plt .data .bss 
   04     .dynamic 
   05     .note.ABI-tag .note.gnu.build-id 
   06     
   07     .ctors .dtors .jcr .dynamic .got 
</code></pre></div>
<p>The following line , shows that stack is Read Write but not executable</p>
<div class='highlight'><pre><code class='text'>  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW 0x4
</code></pre></div>
<p>In order to make the stack executable, the program needs to be compiled with <strong><em>-z execstack</em></strong> option</p>
<div class='highlight'><pre><code class='text'>madhur@bt:~/buffer$ gcc -ggdb -m32 -z execstack -o buffer1 buffer1.c
</code></pre></div>
<p>In that case, the output of <strong><em>readelf</em></strong> program would be</p>
<div class='highlight'><pre><code class='text'>  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4
</code></pre></div>
<p><strong><a href="http://en.wikipedia.org/wiki/Stack-smashing_protection">Stack smashing protection</a></strong> refers to compiler generated protection techniques of smash stacking. Refer to wikipedia link to get more details about the techniques involved in this protection. This can be disabled in gcc as follows:</p>
<div class='highlight'><pre><code class='text'>madhur@bt:~/buffer$ gcc -ggdb -m32 -o buffer1 -fno-stack-protector -mpreferred-stack-boundary=4 buffer1.c
</code></pre></div>
<p><strong>Windows Implementation</strong> The /GS switch is a compiler option that will add some code to functionâ€™s prologue and epilogue code in order to prevent successful abuse of typical stack based (string buffer) overflows.</p>

<p>When an application starts, a program-wide master cookie (4 bytes (dword), unsigned int) is calculated (pseudo-random number) and saved in the .data section of the loaded module. In the function prologue, this program-wide master cookie is copied to the stack, right before the saved EBP and EIP. (between the local variables and the return addresses)</p>

<p>[buffer][cookie][saved EBP][saved EIP] During the epilogue, this cookie is compared again with the program-wide master cookie. If it is different, it concludes that corruption has occurred, and the program is terminated.</p>

<p>In order to minimize the performance impact of the extra lines of code, the compiler will only add the stack cookie if the function contains string buffers or allocates memory on the stack using <strong><em>alloca</em></strong>. Furthermore, the protection is only active when the buffer contains 5 bytes or more.</p>

<p>In a typical buffer overflow, the stack is attacked with your own data in an attempt to overwrite the saved EIP. But before your data overwrites the saved EIP, the cookie is overwritten as well, rendering the exploit useless (but it may still lead to a DoS). The function epilogue would notice that the cookie has been changed, and the application dies.</p>
<pre>
|buffer||cookie||saved EBP||saved EIP|
|AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|
         ^
         |
</pre>
<p>The second important protection mechanism of /GS is variable reordering. In order to prevent attackers from overwriting local variables or arguments used by the function, the compiler will rearrange the layout of the stack frame, and will put string buffers at a higher address than all other variables. So when a string buffer overflow occurs, it cannot overwrite any other local variables.</p>

<p><strong>Position Independent Executables (PIE)</strong> In order to take advantage of Address Space Layout Randomization (ASLR), programs need to be built as Position Independent Executables (PIE) with -fPIE â€“pie flag. PIE has a 5-10% performance penalty on architectures with small numbers of general registers (e.g. x86).</p>

<p><strong>Fortify Source</strong> enables several compile-time and run-time protections including protections against overflows. In order to use Fortify Source which provides run-time checks of buffer lengths and memory regions, programs need to be built with -D_FORTIFY_SOURCE=2 flag.</p>

<p><strong>Stack Protector</strong> is enabled at compile-time with -fstack-protector flag. It enables run-time stack overflow verification protecting against stack overflows, and reducing the chances of arbitrary code execution via controlling return address destinations.</p>
			<footer>
				<div class="blocked tags">
					<p>
					
						<a href="/tags/security">Security</a> |
					
						<a href="/tags/exploits">Exploits</a> |
					
					</p>
				</div>
			</footer>
			
			<br/>
			<div>


				<!-- Enable Google Plus comments -->
				<!-- Place this tag where you want the +1 button to render -->
<div class="social">
<g:plusone></g:plusone>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="madhur25">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<fb:like href="http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html" send="true" layout="button_count" width="450" show_faces="true" colorscheme="dark" font="lucida grande"></fb:like>
</div>


<!-- Place this tag after the last plusone tag -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


			</div>
			
			
			<div class="hr"></div>

		


			<!-- Discus Comments -->
			<div id="disqus_thread"></div>

			
			<!-- Enable Disqus comments -->
			<script type="text/javascript">
  var disqus_developer = 0; // developer mode is on
  var disqus_shortname = 'madhur';
  var disqus_identifier = '/2011/08/06/protbufferoverflow/';
  var disqus_title = 'Protections against buffer overflow exploits in Linux';
  var disqus_url = 'http://madhur.co.in/blog/2011/08/06/protbufferoverflow.html';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

</script>

			
			
			

		</article>

		<div class="c">&nbsp;</div>

	</div>

	
</section>
 
<div class="c">&nbsp;</div>


  
<script type="text/javascript">
    
    var disqus_shortname = 'madhur'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

 

 



		</div>
		  
		<footer id="footer" class="span-24 last">
			
				<p id="copyright">
					&copy; 2011-2014
					Madhur Ahuja
				</p>
				<p id="poweredby">
					Powered by 
					<a href="http://jekyllrb.com" title="A static, minimalist CMS">Jekyll</a>, <a href="http://github.com/">Github</a> and <a href="http://disqus.com">Disqus</a>.
				</p>

				<div class="c">&nbsp;</div>

			
		</footer>

	</div>

</div>

</body>
</html>
