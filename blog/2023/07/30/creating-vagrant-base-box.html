<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" /> 
    <title>Creating vagrant basebox &#8211; Madhur Ahuja</title>
    

    <meta name="author" content="Madhur Ahuja" />
    <meta name="description" content=" Creating vagrant basebox" />

    <link rel="start" href="/" />

    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />

    <link rel="stylesheet" href="/files/css/bootstrap.min.css" type="text/css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
    <script src="/files/js/vendor/fancybox.umd.js" tpye="text/javascript"></script>
    <link rel="stylesheet" href="/files/css/fancybox.css" type="text/css" />

    <link rel="stylesheet" type="text/css" href="/files/css/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/files/css/syntax.css" /> 

     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N14VDHYFHQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N14VDHYFHQ');
</script> 
    <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css"> 

    <script src="/files/js/vendor/pace.min.js" type="text/javascript"></script>
</head>


<body>

    <div class="container">

        <header id="header" class="row">

            <nav id="navigation" class="navbar navbar-inverse navbar-fixed-top top-nav-collapse" role="navigation">
    <div class="container">

        <div class="navbar-header">

            <div class="hidden-md hidden-sm hidden-lg searchli">

                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q2" name="q" value="" class="form-control mobile"
                            placeholder="Search" />
                    </div>
                </form>
            </div>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mainmenu">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--  <a class="navbar-brand " href="/">Home</a> -->
        </div>

        <div class="collapse navbar-collapse" id="mainmenu">
            <ul id="nav" class="nav navbar-nav">

                <li><a class="home" href="/">Home</a>
                </li>
                <li><a class="blog" href="/blog">Blog</a>
                </li>
                <!--<li><a class="work" href="/work">Resume</a></li>-->
                <li><a class="code" href="/projects">Work</a>
                </li>
                <!--<li><a class="papers" href="/papers">Papers</a></li>-->
                <li><a class="info" href="/info">About</a>
                </li>
                <li><a class="contact" href="/contact">Contact</a>
                </li>

            </ul>

            <ul class="nav navbar-nav visible-md visible-lg visible-sm searchbox">
                <li>
                    <form method="get" role="search" id="searchform" action="/results"
                        onsubmit="return checkfrm_search();">

                        <div class="form-group">
                            <input type="search" required id="q1" name="q" value="" class="form-control desktop"
                                placeholder="Search" />
                        </div>
                    </form>
                </li>
            </ul>


            <ul class="nav-icons navbar-right nav navbar-nav visible-md visible-lg">
                <li><a href="http://www.linkedin.com/in/madhurahuja"><i class="fa fa-linkedin-square fa-3x"></i></a>
                </li>
                <li><a href="https://github.com/madhur"><i class="fa fa-github fa-3x"></i></a>
                </li>
                <li><a href="http://feeds.feedburner.com/madhur"><i class="fa fa-rss-square fa-3x"></i></a>
                </li>
            </ul>


        </div>

    </div>
</nav>

        </header>

        <div id="content" class="row">

            <section>

	<div id="blogcontent">


		<article id="blog-article" class="post col-md-12 clearfix">

			<header>
				<h1>Creating vagrant basebox</h1>
			</header>

			



<div class="post-meta">
    <time datetime="2023-07-30T00:00:00+05:30">July 30, 2023</time>
    <span class="reading-time">6 min read</span>
</div>


			<hr style="margin-top:0px" />


			<p>For me, <a href="https://www.vagrantup.com/">Vagrant</a> is the ultimate tool to simulate production like envrionments in the development machine.</p>

<p>Some people prefer <a href="https://www.docker.com/">Docker</a> as an alternative to Vagrant, because of being lightweight and quick to provision.</p>

<p>However, I feel Docker and Vagrant have their own places and their responsibilities do not overlap. Let me explain why.</p>

<ul>
  <li>
    <p>Docker is good for running application services. Ultimately, now a days, since production code is deployed in containers itself, docker provides good testing ground for testing out <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> and <a href="https://docs.docker.com/engine/reference/commandline/images/">images</a></p>
  </li>
  <li>
    <p>Though application services are deployed on containers, the stateful sets have not really reached that maturity stage where the persistent stores are deployed in containers.</p>
  </li>
</ul>

<p>Organizations still prefer to run the <a href="https://cassandra.apache.org/_/index.html">Cassandra</a>, <a href="https://redis.io/">Redis</a>, <a href="https://www.mongodb.com/">MongoDB</a>, <a href="https://www.mysql.com/">MySQL</a> in the cloud VM’s  if those are self hosted, instead of the containers.</p>

<p>This is where Vagrant becomes a crucial tool for sysadmins.</p>

<p>Any sysadmin, who manages such infrastructure would find Vagrant an incredibly useful tool to replicate the entire setup on development environment and test out any changes in its development environment before proceeding to higher environments.</p>

<p>For example, someone testing out the Cassandra DB cluster upgrade, can test it out in Vagrant environment before doing it in staging / production environment. This can help save cost.</p>

<p>There are <a href="https://app.vagrantup.com/boxes/search">Vagrant boxes</a> available for each and every popular Operating systems such as <a href="https://app.vagrantup.com/centos/boxes/7">CentOS 7</a>, <a href="https://app.vagrantup.com/generic/boxes/centos8">CentOS 8</a> and <a href="https://app.vagrantup.com/debian/boxes/jessie64">Debian</a></p>

<p><a href="https://github.com/search?q=vagrant+mysql&amp;type=repositories">Github</a> is full of open source scripts to provision any type of server with Vagrant.</p>

<p>Sometimes, it is helpful to create your own <a href="https://developer.hashicorp.com/vagrant/docs/boxes/base">Vagrant base box</a> in order to avoid downloading big dependencies from package repositories such as <a href="https://wiki.debian.org/apt-get#:~:text=apt%2Dget%20is%20a%20tool,part%20of%20the%20DebianPackageManagement%20system.">apt</a> or <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/managing_software_with_the_dnf_tool/index">dnf</a></p>

<p>The dependencies can be packaged inside Vagrant basebox itself so that when the box is provisioned, there is no need to download these cut shorting the time to provision.</p>

<p>Recently, I had such a scenario and found some important tips when creating own vagrant boxes.</p>

<ul>
  <li>The official guidelines for creating base box for <a href="https://www.virtualbox.org/">Virtualbox</a>  <a href="https://developer.hashicorp.com/vagrant/docs/providers/virtualbox/boxes">https://developer.hashicorp.com/vagrant/docs/providers/virtualbox/boxes</a> recommends installing <a href="https://www.virtualbox.org/manual/ch04.html">Virtual Box guest additions</a> in the basebox. Infact, it has been listed as a must.</li>
</ul>

<blockquote>
  <p>VirtualBox Guest Additions must be installed so that things such as shared folders can function. Installing guest additions also usually improves performance since the guest OS can make some optimizations by knowing it is running within VirtualBox.</p>
</blockquote>

<p>This is one of the most illogical and idiotic advice according to me. Because, VirtualBox Guest additions package is tied to specific version of VirtualBox. Once you install VirtualBox Guest additions package and later upgrade or downgrade VirtualBox version, it is of no use. This creates a tight coupling between the consumer (developer) and the Vagrant Base box. According to me, installing Virtual Box Guest Additions package is best avoided unless you really need fancy two way synchronizations between host and guest folders, which I believe no serious sysadmin should care about.</p>

<ul>
  <li>
    <p>When you provision a Vagrant box, the folder in which <code class="language-plaintext highlighter-rouge">Vagrantfile</code> resides is mounted inside the guest machine as <code class="language-plaintext highlighter-rouge">/vagrant</code>. Before executing <code class="language-plaintext highlighter-rouge">vagrant package --base basebox</code>, which triggers the creation of basebox, make sure to delete the <code class="language-plaintext highlighter-rouge">/vagrant</code> folder else it will be packaged as a regular folder inside the basebox which in most cases you don’t want.</p>
  </li>
  <li>
    <p>It is very important to keep the size of basebox as small as possible to make sure it does not occupy huge disk space when boxes are provisioned from the base box. Vagrant does the compression of the basebox, however it does the compression based on the binary analysis of the disk. If there has been lot of files in and out of the box, even after deleting those files, the space won’t be reclaimed by vagrant compression. Hence its best to zero out the empty space before initiating creation of box using</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Zero free space to aid VM compression</span>
<span class="nb">printf</span> <span class="s2">"STEP: Zero free space to aid VM compression</span><span class="se">\n</span><span class="s2">"</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/EMPTY <span class="nv">bs</span><span class="o">=</span>1M
<span class="nb">rm</span> <span class="nt">-f</span> /EMPTY
</code></pre></div></div>
<p>The above step should take care of filling the empty space with zeroes which vagrant would be able to compress out signifcantly.</p>

<ul>
  <li>If you care about the space optimzation very deeply, there are certain files such as <a href="https://www.kernel.org/doc/man-pages/">man pages</a> and <a href="https://en.wikipedia.org/wiki/Logging_(computing)">log files</a> which can be removed from Linux OS. Have a look at this <a href="https://gist.github.com/carlessanagustin/2fb92e88f2068300a2ed">gist</a> for such tweaks to optimize. I am recopying the gist below incase gist is later unavailable:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#!/bin/sh</span>
 
<span class="c"># Credits to:</span>
<span class="c">#  - http://vstone.eu/reducing-vagrant-box-size/</span>
<span class="c">#  - https://github.com/mitchellh/vagrant/issues/343</span>
<span class="c">#  - https://gist.github.com/adrienbrault/3775253</span>

<span class="c">## for vagrant related tasks, uncomment vagrant comments</span>
 
<span class="c"># vagrant: Unmount project</span>
<span class="c">#printf "STEP: vagrant: Unmount project\n"</span>
<span class="c">#umount /vagrant</span>
 
<span class="c"># Remove APT cache</span>
<span class="nb">printf</span> <span class="s2">"STEP: Remove APT cache</span><span class="se">\n</span><span class="s2">"</span>
apt-get clean <span class="nt">-y</span>
apt-get autoclean <span class="nt">-y</span>
 
<span class="c"># Zero free space to aid VM compression</span>
<span class="nb">printf</span> <span class="s2">"STEP: Zero free space to aid VM compression</span><span class="se">\n</span><span class="s2">"</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/EMPTY <span class="nv">bs</span><span class="o">=</span>1M
<span class="nb">rm</span> <span class="nt">-f</span> /EMPTY
 
<span class="c"># Remove APT files</span>
<span class="nb">printf</span> <span class="s2">"STEP: Zero free space to aid VM compression</span><span class="se">\n</span><span class="s2">"</span>
find /var/lib/apt <span class="nt">-type</span> f | xargs <span class="nb">rm</span> <span class="nt">-f</span>
 
<span class="c"># Remove documentation files</span>
<span class="nb">printf</span> <span class="s2">"STEP: Remove documentation files</span><span class="se">\n</span><span class="s2">"</span>
find /var/lib/doc <span class="nt">-type</span> f | xargs <span class="nb">rm</span> <span class="nt">-f</span>
 
<span class="c"># vagrant: Remove Virtualbox specific files</span>
<span class="c">#printf "STEP: vagrant: Remove Virtualbox specific files\n"</span>
<span class="c">#rm -rf /usr/src/vboxguest* /usr/src/virtualbox-ose-guest*</span>
 
<span class="c"># Remove Linux headers</span>
<span class="nb">printf</span> <span class="s2">"STEP: Remove Linux headers</span><span class="se">\n</span><span class="s2">"</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /usr/src/linux-headers<span class="k">*</span>
 
<span class="c"># Remove Unused locales (edit for your needs, this keeps only en* and pt_BR)</span>
<span class="nb">printf</span> <span class="s2">"STEP: Remove Unused locales (edit for your needs, this keeps only en* and pt_BR)
find</span><span class="se">\n</span><span class="s2">"</span> 
find /usr/share/locale/<span class="o">{</span>af,am,ar,as,ast,az,bal,be,bg,bn,bn_IN,br,bs,byn,ca,cr,cs,csb,cy,da,de,de_AT,dz,el,en_AU,en_CA,eo,es,et,et_EE,eu,fa,fi,fo,fr,fur,ga,gez,gl,gu,haw,he,hi,hr,hu,hy,id,is,it,ja,ka,kk,km,kn,ko,kok,ku,ky,lg,lt,lv,mg,mi,mk,ml,mn,mr,ms,mt,nb,ne,nl,nn,no,nso,oc,or,pa,pl,ps,qu,ro,ru,rw,si,sk,sl,so,sq,sr,sr<span class="k">*</span>latin,sv,sw,ta,te,th,ti,tig,tk,tl,tr,tt,ur,urd,ve,vi,wa,wal,wo,xh,zh,zh_HK,zh_CN,zh_TW,zu<span class="o">}</span> <span class="nt">-type</span> d <span class="nt">-delete</span>
 
<span class="c"># Remove bash history</span>
<span class="nb">printf</span> <span class="s2">"STEP: Remove bash history</span><span class="se">\n</span><span class="s2">"</span>
<span class="nb">unset </span>HISTFILE
<span class="nb">rm</span> <span class="nt">-f</span> /root/.bash_history

<span class="c"># vagrant: Remove bash history</span>
<span class="c">#printf "STEP: vagrant: Remove bash history\n"</span>
<span class="c">#rm -f /home/vagrant/.bash_history</span>
 
<span class="c"># Cleanup log files</span>
<span class="nb">printf</span> <span class="s2">"STEP: Cleanup log files</span><span class="se">\n</span><span class="s2">"</span>
find /var/log <span class="nt">-type</span> f | <span class="k">while </span><span class="nb">read </span>f<span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nt">-ne</span> <span class="s1">''</span> <span class="o">&gt;</span> <span class="nv">$f</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span>
 
<span class="c"># Whiteout root</span>
<span class="nb">printf</span> <span class="s2">"STEP: Whiteout root</span><span class="se">\n</span><span class="s2">"</span>
<span class="nv">count</span><span class="o">=</span><span class="sb">`</span><span class="nb">df</span> <span class="nt">--sync</span> <span class="nt">-kP</span> / | <span class="nb">tail</span> <span class="nt">-n1</span>  | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">' '</span> <span class="s1">'{print $4}'</span><span class="sb">`</span><span class="p">;</span>
<span class="nv">count</span><span class="o">=</span><span class="k">$((</span>count <span class="o">-=</span> <span class="m">1</span><span class="k">))</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/tmp/whitespace <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span><span class="nv">$count</span><span class="p">;</span>
<span class="nb">rm</span> /tmp/whitespace<span class="p">;</span>
 
<span class="c"># Whiteout /boot</span>
<span class="nb">printf</span> <span class="s2">"STEP: Whiteout /boot</span><span class="se">\n</span><span class="s2">"</span>
<span class="nv">count</span><span class="o">=</span><span class="sb">`</span><span class="nb">df</span> <span class="nt">--sync</span> <span class="nt">-kP</span> /boot | <span class="nb">tail</span> <span class="nt">-n1</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">' '</span> <span class="s1">'{print $4}'</span><span class="sb">`</span><span class="p">;</span>
<span class="nv">count</span><span class="o">=</span><span class="k">$((</span>count <span class="o">-=</span> <span class="m">1</span><span class="k">))</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/boot/whitespace <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span><span class="nv">$count</span><span class="p">;</span>
<span class="nb">rm</span> /boot/whitespace<span class="p">;</span>
 
<span class="c"># Whiteout swap </span>
<span class="nb">printf</span> <span class="s2">"STEP: Whiteout swap</span><span class="se">\n</span><span class="s2">"</span>
<span class="nv">swappart</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /proc/swaps | <span class="nb">tail</span> <span class="nt">-n1</span> | <span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">' '</span> <span class="s1">'{print $1}'</span><span class="sb">`</span>
swapoff <span class="nv">$swappart</span><span class="p">;</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$swappart</span><span class="p">;</span>
mkswap <span class="nv">$swappart</span><span class="p">;</span>
swapon <span class="nv">$swappart</span><span class="p">;</span>

</code></pre></div></div>

			<footer>
				<div class="blocked tags">
					<p>
						
						<a href="/blog/tags/vagrant">Vagrant</a> |
						
					</p>
				</div>
			</footer>

			<br />



			<div class="hr"></div>

		</article>

		<div class="c">&nbsp;</div>

	</div>


</section>

<div class="c">&nbsp;</div>

        </div>


        <footer id="footer" class="row">

            <p id="copyright">
                &copy; 2011-2026 Madhur Ahuja
            </p>
            <p id="poweredby" class="visible-lg visible-md">
                Powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://github.com/">Github</a>.
            </p>

            <div class="c">&nbsp;</div>


        </footer>


    </div>

    <script src="/files/js/main.js"></script> 
    

    <!-- serviceWorker.html -->
    <script>
        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister()
                }
            })
        }

// if ('serviceWorker' in navigator) {
//     navigator.serviceWorker.register('/serviceWorker.js').then(function(reg) {
//         if (!reg.installing) return;
//         console.log("[*] ServiceWorker is installing...");

//         var worker = reg.installing;
//         worker.addEventListener('statechange', function() {
//             if (worker.state == 'redundant') {
//                 console.log('[*] Install failed');
//             }
//             if (worker.state == 'installed') {
//                 console.log('[*] Install successful!');
//             }
//         });
//     });
// }

    </script>

</body>

</html>