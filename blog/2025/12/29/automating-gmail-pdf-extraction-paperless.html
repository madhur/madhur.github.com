<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" /> 
    <title>Automating Gmail PDF Extraction and Paperless NGX Integration &#8211; Madhur Ahuja</title>
    

    <meta name="author" content="Madhur Ahuja" />
    <meta name="description" content=" Automating Gmail PDF Extraction and Paperless NGX Integration" />

    <link rel="start" href="/" />

    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />

    <link rel="stylesheet" href="/files/css/bootstrap.min.css" type="text/css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
    <script src="/files/js/vendor/fancybox.umd.js" tpye="text/javascript"></script>
    <link rel="stylesheet" href="/files/css/fancybox.css" type="text/css" />

    <link rel="stylesheet" type="text/css" href="/files/css/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/files/css/syntax.css" /> 

     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N14VDHYFHQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N14VDHYFHQ');
</script> 
    <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css"> 

    <script src="/files/js/vendor/pace.min.js" type="text/javascript"></script>
</head>


<body>

    <div class="container">

        <header id="header" class="row">

            <nav id="navigation" class="navbar navbar-inverse navbar-fixed-top " role="navigation">
    <div class="container">

        <div class="navbar-header">

            <div class="hidden-md hidden-sm hidden-lg searchli">

                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q2" name="q" value="" class="form-control mobile"
                            placeholder="Search" />
                    </div>
                </form>
            </div>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mainmenu">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--  <a class="navbar-brand " href="/">Home</a> -->
        </div>

        <div class="collapse navbar-collapse" id="mainmenu">
            <ul id="nav" class="nav navbar-nav">

                <li><a class="home" href="/">Home</a>
                </li>
                <li><a class="blog" href="/blog">Blog</a>
                </li>
                <!--<li><a class="work" href="/work">Resume</a></li>-->
                <li><a class="code" href="/projects">Work</a>
                </li>
                <!--<li><a class="papers" href="/papers">Papers</a></li>-->
                <li><a class="info" href="/info">About</a>
                </li>
                <li><a class="contact" href="/contact">Contact</a>
                </li>

            </ul>

            <ul class="nav navbar-nav visible-md visible-lg visible-sm searchbox">
                <li>
                    <form method="get" role="search" id="searchform" action="/results"
                        onsubmit="return checkfrm_search();">

                        <div class="form-group">
                            <input type="search" required id="q1" name="q" value="" class="form-control desktop"
                                placeholder="Search" />
                        </div>
                    </form>
                </li>
            </ul>


            <ul class="nav-icons navbar-right nav navbar-nav visible-md visible-lg">
                <li><a href="http://www.linkedin.com/in/madhurahuja"><i class="fa fa-linkedin-square fa-3x"></i></a>
                </li>
                <li><a href="https://github.com/madhur"><i class="fa fa-github fa-3x"></i></a>
                </li>
                <li><a href="http://feeds.feedburner.com/madhur"><i class="fa fa-rss-square fa-3x"></i></a>
                </li>
            </ul>


        </div>

    </div>
</nav>

        </header>

        <div id="content" class="row">

            <section>

	<div id="blogcontent">


		<article id="blog-article" class="post col-md-12 clearfix">

			<header>
				<h1>Automating Gmail PDF Extraction and Paperless NGX Integration</h1>
			</header>

			<div class="row social hidden-xs">
    <div class="col-md-2 col-sm-2">
        <time datetime="2025-12-29 00:00:00 +0530" pubdate="pubdate"
            >29 December 2025</time
        >
    </div>
    <div class="social-icon col-md-2 col-sm-2">
       <a href="https://twitter.com/madhur25?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @madhur25</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
    <div class="social-icon col-md-1 col-sm-2">
        <a
            href="https://twitter.com/share?ref_src=twsrc%5Etfw"
            class="twitter-share-button"
            data-via="madhur25"
            data-show-count="false"
            >Tweet</a
        >
        <script
            async
            src="https://platform.twitter.com/widgets.js"
            charset="utf-8"
        ></script>
    </div>

    <div class="social-icon col-md-1 col-sm-2">
        <a
            data-pocket-label="pocket"
            data-pocket-count="horizontal"
            class="pocket-btn"
            data-lang="en"
        ></a>
        <script type="text/javascript">
            !(function (d, i) {
                if (!d.getElementById(i)) {
                    var j = d.createElement("script");
                    j.id = i;
                    j.src = "https://widgets.getpocket.com/v1/j/btn.js?v=1";
                    var w = d.getElementById(i);
                    d.body.appendChild(j);
                }
            })(document, "pocket-btn-js");
        </script>
    </div>
</div>


			<hr style="margin-top:0px" />


			<p>Managing financial documents like bank statements, credit card bills, and tax documents can be tedious. I’ve automated this process with a Python script that:</p>

<ol>
  <li>Scans Gmail for emails with PDF attachments</li>
  <li>Extracts and decrypts password-protected PDFs</li>
  <li>Organizes files by date and subject</li>
  <li>Uploads documents to Paperless NGX for long-term storage and OCR</li>
  <li>Sends notifications via ntfy</li>
</ol>

<p>This script runs daily via a systemd timer, ensuring I never miss important documents. All processed documents are accessible through the Paperless NGX web interface and mobile app, making it easy to access important documents on the go.</p>

<h2 id="features">Features</h2>

<ul>
  <li><strong>Automatic PDF Extraction</strong>: Scans Gmail for emails matching configured subject patterns</li>
  <li><strong>Password Removal</strong>: Automatically decrypts password-protected PDFs using configurable patterns</li>
  <li><strong>Email-to-PDF Conversion</strong>: Converts entire emails (not just attachments) to PDF for newsletters and important emails</li>
  <li><strong>Smart Organization</strong>: Organizes files by date (Month-Year) and email subject</li>
  <li><strong>Paperless NGX Integration</strong>: Automatically uploads processed documents with metadata</li>
  <li><strong>Google Drive Backup</strong>: Optional Google Drive upload for additional backup</li>
  <li><strong>Notifications</strong>: Sends notifications via ntfy about processing status</li>
  <li><strong>Duplicate Detection</strong>: Skips files that already exist</li>
</ul>

<h2 id="architecture">Architecture</h2>

<p>The script consists of several modules:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">gmail_reader.py</code>: Main script that orchestrates the entire process</li>
  <li><code class="language-plaintext highlighter-rouge">pdf_processor.py</code>: Handles PDF decryption and validation</li>
  <li><code class="language-plaintext highlighter-rouge">paperless_uploader.py</code>: Manages Paperless NGX API integration</li>
  <li><code class="language-plaintext highlighter-rouge">google_drive_uploader.py</code>: Handles Google Drive uploads (optional)</li>
  <li><code class="language-plaintext highlighter-rouge">ntfy_notifier.py</code>: Sends push notifications</li>
</ul>

<h2 id="installation">Installation</h2>

<h3 id="prerequisites">Prerequisites</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>PyPDF2 weasyprint html2text pyyaml requests google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
</code></pre></div></div>

<h3 id="configuration">Configuration</h3>

<p>Create a <code class="language-plaintext highlighter-rouge">config.yaml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">documents</span><span class="pi">:</span>
  <span class="na">Bank Statement</span><span class="pi">:</span>
    <span class="na">subject_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Your</span><span class="nv"> </span><span class="s">Bank</span><span class="nv"> </span><span class="s">Statement"</span>
    <span class="na">password_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your_password_here"</span>
    
  <span class="na">Credit Card</span><span class="pi">:</span>
    <span class="na">subject_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Your</span><span class="nv"> </span><span class="s">Credit</span><span class="nv"> </span><span class="s">Card</span><span class="nv"> </span><span class="s">Statement"</span>
    <span class="na">password_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">card_number@{ddmm}"</span>  <span class="c1"># Date-based password</span>
    
  <span class="na">Tax Document</span><span class="pi">:</span>
    <span class="na">subject_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Your</span><span class="nv"> </span><span class="s">ITR"</span>
    <span class="na">password_pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pan_number@dob"</span>

<span class="c1"># Email-to-PDF conversion for newsletters</span>
<span class="na">email_to_pdf</span><span class="pi">:</span>
  <span class="na">newsletters</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">subject_regex</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Monthly</span><span class="nv"> </span><span class="s">Newsletter"</span>
    <span class="na">allow_duplicates</span><span class="pi">:</span> <span class="no">false</span>

<span class="c1"># Email filters</span>
<span class="na">email_filters</span><span class="pi">:</span>
  <span class="na">max_results</span><span class="pi">:</span> <span class="m">50</span>
  <span class="na">days_to_search</span><span class="pi">:</span> <span class="m">30</span>

<span class="c1"># PDF settings</span>
<span class="na">pdf_settings</span><span class="pi">:</span>
  <span class="na">output_directory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">decrypted_statements"</span>
  <span class="na">open_after_decrypt</span><span class="pi">:</span> <span class="no">false</span>

<span class="c1"># Gmail settings</span>
<span class="na">email_settings</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your_email@gmail.com"</span>
  <span class="na">app_password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your_app_password"</span>  <span class="c1"># Generate from Google Account settings</span>

<span class="c1"># Notifications (optional)</span>
<span class="na">ntfy_settings</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">server_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://ntfy.sh"</span>  <span class="c1"># Or your own ntfy server</span>
  <span class="na">topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your_topic_name"</span>
  <span class="na">default_priority</span><span class="pi">:</span> <span class="s2">"</span><span class="s">default"</span>

<span class="c1"># Google Drive (optional)</span>
<span class="na">google_drive_settings</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">service_account_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">oauth_credentials.json"</span>
  <span class="na">upload_after_decrypt</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">keep_local_copy</span><span class="pi">:</span> <span class="no">true</span>

<span class="c1"># Paperless NGX settings</span>
<span class="na">paperless_settings</span><span class="pi">:</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">base_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://paperless.example.com"</span>
  <span class="na">api_token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">your_api_token"</span>  <span class="c1"># Get from Paperless admin panel</span>
  <span class="na">timeout</span><span class="pi">:</span> <span class="m">30</span>
  <span class="na">default_tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">Email</span><span class="nv"> </span><span class="s">Import"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">Auto</span><span class="nv"> </span><span class="s">Processed"</span>
  <span class="na">default_correspondent</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Email</span><span class="nv"> </span><span class="s">System"</span>
  <span class="na">default_document_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Statement"</span>
</code></pre></div></div>

<h3 id="gmail-app-password">Gmail App Password</h3>

<p>To use Gmail IMAP, you need to generate an app password:</p>

<ol>
  <li>Go to <a href="https://myaccount.google.com/">Google Account Settings</a></li>
  <li>Navigate to Security → 2-Step Verification</li>
  <li>Scroll down to “App passwords”</li>
  <li>Generate a new app password for “Mail”</li>
  <li>Use this password in your <code class="language-plaintext highlighter-rouge">config.yaml</code></li>
</ol>

<h2 id="core-script">Core Script</h2>

<p>Here’s the main <code class="language-plaintext highlighter-rouge">gmail_reader.py</code> script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">imaplib</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">google_drive_uploader</span> <span class="kn">import</span> <span class="n">upload_to_drive</span>
<span class="kn">from</span> <span class="nn">paperless_uploader</span> <span class="kn">import</span> <span class="n">upload_to_paperless</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">pdf_processor</span> <span class="kn">import</span> <span class="n">PDFProcessor</span>
<span class="kn">from</span> <span class="nn">ntfy_notifier</span> <span class="kn">import</span> <span class="n">NtfyNotifier</span>

<span class="c1"># For email-to-PDF conversion
</span><span class="kn">import</span> <span class="nn">weasyprint</span>
<span class="kn">from</span> <span class="nn">email.message</span> <span class="kn">import</span> <span class="n">EmailMessage</span>
<span class="kn">import</span> <span class="nn">html2text</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="kn">from</span> <span class="nn">email.utils</span> <span class="kn">import</span> <span class="n">parsedate_to_datetime</span>


<span class="k">class</span> <span class="nc">ImprovedGmailPDFProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s">'config.yaml'</span><span class="p">):</span>
        <span class="s">"""Initialize with configuration file."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">setup_logging</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">setup_output_directory</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pdf_processor</span> <span class="o">=</span> <span class="n">PDFProcessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">notifier</span> <span class="o">=</span> <span class="n">NtfyNotifier</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'ntfy_settings'</span><span class="p">,</span> <span class="p">{}))</span>
        
        <span class="c1"># Track processing statistics
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'total_emails_found'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'total_pdfs_found'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'new_pdfs_processed'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'skipped_existing'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'errors'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'paperless_uploads'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'paperless_failures'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'email_pdfs_created'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'email_pdf_failures'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">'new_files'</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Setup logging configuration."""</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s">'gmail_pdf_processor.log'</span><span class="p">),</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
        <span class="s">"""Load configuration from YAML file."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Configuration loaded successfully"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Error loading config file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_to_gmail</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">imaplib</span><span class="p">.</span><span class="n">IMAP4_SSL</span><span class="p">:</span>
        <span class="s">"""Connect to Gmail using IMAP."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mail</span> <span class="o">=</span> <span class="n">imaplib</span><span class="p">.</span><span class="n">IMAP4_SSL</span><span class="p">(</span><span class="s">"imap.gmail.com"</span><span class="p">)</span>
            <span class="n">mail</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'email_settings'</span><span class="p">][</span><span class="s">'email'</span><span class="p">],</span> 
                      <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'email_settings'</span><span class="p">][</span><span class="s">'app_password'</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Successfully connected to Gmail"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mail</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Failed to connect to Gmail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_recent_emails_for_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mail</span><span class="p">:</span> <span class="n">imaplib</span><span class="p">.</span><span class="n">IMAP4_SSL</span><span class="p">,</span> <span class="n">subject_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
        <span class="s">"""Fetch recent emails matching a specific pattern."""</span>
        <span class="n">mail</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">'INBOX'</span><span class="p">)</span>
        
        <span class="n">days</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'email_filters'</span><span class="p">][</span><span class="s">'days_to_search'</span><span class="p">]</span>
        <span class="n">date_since</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)).</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%d-%b-%Y"</span><span class="p">)</span>
        <span class="n">search_criteria</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'(SINCE "</span><span class="si">{</span><span class="n">date_since</span><span class="si">}</span><span class="s">" SUBJECT "</span><span class="si">{</span><span class="n">subject_pattern</span><span class="si">}</span><span class="s">")'</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Searching for pattern '</span><span class="si">{</span><span class="n">subject_pattern</span><span class="si">}</span><span class="s">' since </span><span class="si">{</span><span class="n">date_since</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">result</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">search_criteria</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
        
        <span class="n">max_results</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'email_filters'</span><span class="p">][</span><span class="s">'max_results'</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="n">max_results</span><span class="p">:]</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">is_pdf_attachment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Check if email part is a PDF attachment."""</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">part</span><span class="p">.</span><span class="n">get_content_type</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">part</span><span class="p">.</span><span class="n">get_filename</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s">'application/pdf'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        
        <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s">'application/octet-stream'</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filename</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.pdf'</span><span class="p">)</span>
        
        <span class="n">content_disposition</span> <span class="o">=</span> <span class="n">part</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Disposition'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">'attachment'</span> <span class="ow">in</span> <span class="n">content_disposition</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filename</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.pdf'</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_email_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Extract email date from message."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date_str</span> <span class="o">=</span> <span class="n">email_message</span><span class="p">[</span><span class="s">'Date'</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">date_str</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s">"Email has no Date header, using current date"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y/%m/%d"</span><span class="p">)</span>
            
            <span class="n">email_date</span> <span class="o">=</span> <span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">email_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y/%m/%d"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error parsing email date: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y/%m/%d"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_date_subfolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_date_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Create date-based subfolder (Month-YYYY format)."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">email_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">email_date_str</span><span class="p">,</span> <span class="s">"%Y/%m/%d"</span><span class="p">)</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">email_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%B-%Y"</span><span class="p">)</span>
            <span class="n">subfolder_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subfolder_path</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">subfolder_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Created subfolder: </span><span class="si">{</span><span class="n">subfolder_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">subfolder_path</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error creating date subfolder: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">base_output_dir</span>

    <span class="k">def</span> <span class="nf">sanitize_folder_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Sanitize folder name by removing invalid characters."""</span>
        <span class="n">invalid_chars</span> <span class="o">=</span> <span class="s">'&lt;&gt;:"/</span><span class="se">\\</span><span class="s">|?*'</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">invalid_chars</span><span class="p">:</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">folder_name</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">'_'</span><span class="p">)</span>
        
        <span class="n">folder_name</span> <span class="o">=</span> <span class="n">folder_name</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">' .'</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">folder_name</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_name</span><span class="p">:</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="s">"Unknown_Subject"</span>
            
        <span class="k">return</span> <span class="n">folder_name</span>

    <span class="k">def</span> <span class="nf">get_password_for_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">email_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Generate password based on pattern and date."""</span>
        <span class="n">password_pattern</span> <span class="o">=</span> <span class="n">doc_config</span><span class="p">[</span><span class="s">'password_pattern'</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">email_date</span><span class="p">,</span> <span class="s">"%Y/%m/%d"</span><span class="p">)</span>
        
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'{yyyy}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y'</span><span class="p">),</span>
            <span class="s">'{yy}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%y'</span><span class="p">),</span>
            <span class="s">'{mm}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%m'</span><span class="p">),</span>
            <span class="s">'{dd}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%d'</span><span class="p">),</span>
            <span class="s">'{ddmm}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%d%m'</span><span class="p">),</span>
            <span class="s">'{mmyy}'</span><span class="p">:</span> <span class="n">date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%m%y'</span><span class="p">),</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">password_pattern</span> <span class="o">=</span> <span class="n">password_pattern</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">password_pattern</span>

    <span class="k">def</span> <span class="nf">process_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mail</span><span class="p">:</span> <span class="n">imaplib</span><span class="p">.</span><span class="n">IMAP4_SSL</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> 
                     <span class="n">doc_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doc_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Process a single email message."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">msg_data</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="s">'(RFC822)'</span><span class="p">)</span>
            <span class="n">email_body</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">email_message</span> <span class="o">=</span> <span class="n">email</span><span class="p">.</span><span class="n">message_from_bytes</span><span class="p">(</span><span class="n">email_body</span><span class="p">)</span>
            
            <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_email_subject</span><span class="p">(</span><span class="n">email_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subject</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">subject_normalized</span> <span class="o">=</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">doc_config</span><span class="p">[</span><span class="s">'subject_pattern'</span><span class="p">],</span> <span class="n">subject_normalized</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found matching email for </span><span class="si">{</span><span class="n">doc_type</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'total_emails_found'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">email_date</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_email_date</span><span class="p">(</span><span class="n">email_message</span><span class="p">)</span>
                <span class="n">base_output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'pdf_settings'</span><span class="p">][</span><span class="s">'output_directory'</span><span class="p">]</span>
                <span class="n">date_subfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_date_subfolder</span><span class="p">(</span><span class="n">email_date</span><span class="p">,</span> <span class="n">base_output_dir</span><span class="p">)</span>
                <span class="n">subject_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">create_subject_folder</span><span class="p">(</span><span class="n">date_subfolder</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
                
                <span class="c1"># Process attachments
</span>                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">email_message</span><span class="p">.</span><span class="n">walk</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_pdf_attachment</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">part</span><span class="p">.</span><span class="n">get_filename</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
                            <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'total_pdfs_found'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            
                            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">pdf_processor</span><span class="p">.</span><span class="n">check_existing_pdf</span><span class="p">(</span><span class="n">output_filename</span><span class="p">):</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"PDF already exists, skipping: </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'skipped_existing'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">continue</span>
                            
                            <span class="n">pdf_data</span> <span class="o">=</span> <span class="n">part</span><span class="p">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">pdf_processor</span><span class="p">.</span><span class="n">is_pdf_data_valid</span><span class="p">(</span><span class="n">pdf_data</span><span class="p">):</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"Invalid PDF data for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'errors'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">continue</span>
                            
                            <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_password_for_statement</span><span class="p">(</span><span class="n">doc_config</span><span class="p">,</span> <span class="n">email_date</span><span class="p">)</span>
                            
                            <span class="n">success</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pdf_processor</span><span class="p">.</span><span class="n">remove_password_protection</span><span class="p">(</span>
                                <span class="n">pdf_data</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">output_filename</span>
                            <span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully processed new PDF: </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'new_pdfs_processed'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'new_files'</span><span class="p">].</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s">'filename'</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                                    <span class="s">'path'</span><span class="p">:</span> <span class="n">output_filename</span><span class="p">,</span>
                                    <span class="s">'doc_type'</span><span class="p">:</span> <span class="n">doc_type</span><span class="p">,</span>
                                    <span class="s">'subject'</span><span class="p">:</span> <span class="n">subject</span>
                                <span class="p">})</span>
                                
                                <span class="c1"># Upload to Paperless NGX if configured
</span>                                <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'paperless_settings'</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">'enabled'</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">paperless_success</span> <span class="o">=</span> <span class="n">upload_to_paperless</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="n">doc_type</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">paperless_success</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'paperless_uploads'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'paperless_failures'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'paperless_failures'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error uploading to Paperless NGX: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                                    
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error processing email </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="s">'errors'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Main execution function."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Starting the improved PDF processor..."</span><span class="p">)</span>
            
            <span class="n">mail</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">connect_to_gmail</span><span class="p">()</span>
            
            <span class="c1"># Process each document type
</span>            <span class="k">for</span> <span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'documents'</span><span class="p">,</span> <span class="p">{}).</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Processing </span><span class="si">{</span><span class="n">doc_type</span><span class="si">}</span><span class="s"> documents..."</span><span class="p">)</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_recent_emails_for_pattern</span><span class="p">(</span><span class="n">mail</span><span class="p">,</span> <span class="n">doc_config</span><span class="p">[</span><span class="s">'subject_pattern'</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s"> matching emails for </span><span class="si">{</span><span class="n">doc_type</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Processing </span><span class="si">{</span><span class="n">doc_type</span><span class="si">}</span><span class="s"> email </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">process_email</span><span class="p">(</span><span class="n">mail</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_config</span><span class="p">)</span>
            
            <span class="n">mail</span><span class="p">.</span><span class="n">logout</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">print_processing_summary</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_completion_notification</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Processing completed successfully!"</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">notifier</span><span class="p">.</span><span class="n">send_error_notification</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s">"PDF processor failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s">..."</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s">"PDF Processor Error"</span>
            <span class="p">)</span>
            <span class="k">raise</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'Gmail PDF Processor'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-c'</span><span class="p">,</span> <span class="s">'--config'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'config.yaml'</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s">'Path to the configuration YAML file'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: Configuration file '</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="si">}</span><span class="s">' not found!"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">processor</span> <span class="o">=</span> <span class="n">ImprovedGmailPDFProcessor</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">processor</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="pdf-processor-module">PDF Processor Module</h2>

<p>The <code class="language-plaintext highlighter-rouge">pdf_processor.py</code> handles PDF decryption:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">PyPDF2</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>


<span class="k">class</span> <span class="nc">PDFProcessor</span><span class="p">:</span>
    <span class="s">"""Handles PDF processing operations like password removal."""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_pdf_data_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Check if the provided data is valid PDF content."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">pdf_data</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s">'%PDF'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_existing_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Check if a PDF file already exists at the given path."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s">'%PDF'</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error checking existing PDF </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">remove_password_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                  <span class="n">pdf_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> 
                                  <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                  <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="s">"""Remove password protection from PDF and save it."""</span>
        <span class="n">temp_path</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_pdf_data_valid</span><span class="p">(</span><span class="n">pdf_data</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"Invalid PDF data provided"</span>
            
            <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">'.pdf'</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
                <span class="n">temp_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">pdf_data</span><span class="p">)</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="p">.</span><span class="n">name</span>
            
            <span class="n">pdf_reader</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="p">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">pdf_reader</span><span class="p">.</span><span class="n">is_encrypted</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_reader</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Failed to decrypt PDF with provided password"</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Successfully decrypted password-protected PDF"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"PDF was not password-protected"</span><span class="p">)</span>
            
            <span class="n">pdf_writer</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="p">.</span><span class="n">PdfWriter</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pdf_reader</span><span class="p">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="n">pdf_writer</span><span class="p">.</span><span class="n">add_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            
            <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
                <span class="n">pdf_writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully processed PDF: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Error processing PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">error_msg</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_path</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to delete temporary file </span><span class="si">{</span><span class="n">temp_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="paperless-ngx-uploader">Paperless NGX Uploader</h2>

<p>The <code class="language-plaintext highlighter-rouge">paperless_uploader.py</code> handles integration with Paperless NGX:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>


<span class="k">class</span> <span class="nc">PaperlessNGXUploader</span><span class="p">:</span>
    <span class="s">"""A generic uploader for Paperless NGX instances."""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'base_url'</span><span class="p">].</span><span class="n">rstrip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">api_token</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'api_token'</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'timeout'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'Authorization'</span><span class="p">:</span> <span class="sa">f</span><span class="s">'Token </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">api_token</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
            <span class="s">'Accept'</span><span class="p">:</span> <span class="s">'application/json'</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">default_tags</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'default_tags'</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">default_correspondent</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'default_correspondent'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">default_document_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'default_document_type'</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_tag_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_correspondent_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_document_type_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="p">.</span><span class="n">Response</span><span class="p">:</span>
        <span class="s">"""Make an API request to Paperless NGX."""</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">base_url</span><span class="si">}</span><span class="s">/api</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s">"</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"API request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_get_or_create_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""Get tag ID by name, create if doesn't exist."""</span>
        <span class="k">if</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_tag_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_tag_cache</span><span class="p">[</span><span class="n">tag_name</span><span class="p">]</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'/tags/'</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'results'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">tag_id</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'/tags/'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="n">tag_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'id'</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Created new tag: </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s"> (ID: </span><span class="si">{</span><span class="n">tag_id</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">_tag_cache</span><span class="p">[</span><span class="n">tag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_id</span>
        <span class="k">return</span> <span class="n">tag_id</span>

    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                   <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">correspondent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">document_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">created_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="s">"""Upload a file to Paperless NGX."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nb">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s">"File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Uploading file to Paperless NGX: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">mime_type</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mime_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mime_type</span> <span class="o">=</span> <span class="s">'application/octet-stream'</span>
        
        <span class="n">form_data</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">tag_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_tags</span>
        <span class="k">for</span> <span class="n">tag_name</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag_name</span><span class="p">:</span>
                <span class="n">tag_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_or_create_tag</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
                <span class="n">tag_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_id</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tag_ids</span><span class="p">:</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'tags'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_ids</span>
        
        <span class="n">correspondent_name</span> <span class="o">=</span> <span class="n">correspondent</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_correspondent</span>
        <span class="k">if</span> <span class="n">correspondent_name</span><span class="p">:</span>
            <span class="n">correspondent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_or_create_correspondent</span><span class="p">(</span><span class="n">correspondent_name</span><span class="p">)</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'correspondent'</span><span class="p">]</span> <span class="o">=</span> <span class="n">correspondent_id</span>
        
        <span class="n">doc_type_name</span> <span class="o">=</span> <span class="n">document_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_document_type</span>
        <span class="k">if</span> <span class="n">doc_type_name</span><span class="p">:</span>
            <span class="n">doc_type_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_or_create_document_type</span><span class="p">(</span><span class="n">doc_type_name</span><span class="p">)</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'document_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc_type_id</span>
        
        <span class="k">if</span> <span class="n">created_date</span><span class="p">:</span>
            <span class="n">form_data</span><span class="p">[</span><span class="s">'created'</span><span class="p">]</span> <span class="o">=</span> <span class="n">created_date</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'document'</span><span class="p">:</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_request</span><span class="p">(</span>
                <span class="s">'POST'</span><span class="p">,</span>
                <span class="s">'/documents/post_document/'</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">form_data</span><span class="p">,</span>
                <span class="n">files</span><span class="o">=</span><span class="n">files</span>
            <span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully uploaded </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s"> to Paperless NGX"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Test connection to Paperless NGX instance."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'/documents/'</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s">'page_size'</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Successfully connected to Paperless NGX"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to connect to Paperless NGX: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<h2 id="running-paperless-ngx-in-docker">Running Paperless NGX in Docker</h2>

<p>Paperless NGX is a document management system that automatically OCRs and indexes your documents. Here’s how to run it using Docker Compose:</p>

<h3 id="docker-compose-configuration">Docker Compose Configuration</h3>

<p>Create a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/library/postgres:17</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pgdata:/var/lib/postgresql/data</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">paperless</span>
      <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">paperless</span>
      <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">paperless</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">paperless-network</span>

  <span class="na">webserver</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">ghcr.io/paperless-ngx/paperless-ngx:latest</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db</span>
      <span class="pi">-</span> <span class="s">gotenberg</span>
      <span class="pi">-</span> <span class="s">tika</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">data:/usr/src/paperless/data</span>
      <span class="pi">-</span> <span class="s">media:/usr/src/paperless/media</span>
      <span class="pi">-</span> <span class="s">./export:/usr/src/paperless/export</span>
      <span class="pi">-</span> <span class="s">./consume:/usr/src/paperless/consume</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">docker-compose.env</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">paperless-network</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">PAPERLESS_DBHOST</span><span class="pi">:</span> <span class="s">db</span>
      <span class="na">PAPERLESS_TIKA_ENABLED</span><span class="pi">:</span> <span class="m">1</span>
      <span class="na">PAPERLESS_TIKA_GOTENBERG_ENDPOINT</span><span class="pi">:</span> <span class="s">http://gotenberg:3000</span>
      <span class="na">PAPERLESS_TIKA_ENDPOINT</span><span class="pi">:</span> <span class="s">http://tika:9998</span>

  <span class="na">gotenberg</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/gotenberg/gotenberg:8.22</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">paperless-network</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">gotenberg"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">--chromium-disable-javascript=true"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">--chromium-allow-list=file:///tmp/.*"</span>

  <span class="na">tika</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/apache/tika:latest</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">paperless-network</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">data</span><span class="pi">:</span>
  <span class="na">media</span><span class="pi">:</span>
  <span class="na">pgdata</span><span class="pi">:</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">paperless-network</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</code></pre></div></div>

<h3 id="environment-configuration">Environment Configuration</h3>

<p>Create a <code class="language-plaintext highlighter-rouge">docker-compose.env</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Paperless URL (required for public access)</span>
<span class="nv">PAPERLESS_URL</span><span class="o">=</span>https://paperless.example.com

<span class="c"># Secret key (generate a long random string)</span>
<span class="nv">PAPERLESS_SECRET_KEY</span><span class="o">=</span>your_secret_key_here

<span class="c"># Timezone</span>
<span class="nv">PAPERLESS_TIME_ZONE</span><span class="o">=</span>America/New_York

<span class="c"># OCR Language</span>
<span class="nv">PAPERLESS_OCR_LANGUAGE</span><span class="o">=</span>eng
</code></pre></div></div>

<h3 id="installation-steps">Installation Steps</h3>

<ol>
  <li><strong>Create directories</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> paperless/<span class="o">{</span><span class="nb">export</span>,consume<span class="o">}</span>
<span class="nb">cd </span>paperless
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Create the docker-compose.yml and docker-compose.env files</strong> (as shown above)</p>
  </li>
  <li><strong>Pull images</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose pull
</code></pre></div>    </div>
  </li>
  <li><strong>Start Paperless</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up <span class="nt">-d</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Create admin user</strong>:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose <span class="nb">exec </span>webserver createsuperuser
</code></pre></div>    </div>
  </li>
  <li><strong>Get API token</strong>:
    <ul>
      <li>Log in to Paperless web interface</li>
      <li>Go to Settings → API Tokens</li>
      <li>Create a new token</li>
      <li>Use this token in your <code class="language-plaintext highlighter-rouge">config.yaml</code></li>
    </ul>
  </li>
</ol>

<h3 id="accessing-paperless">Accessing Paperless</h3>

<ul>
  <li>Web interface: <code class="language-plaintext highlighter-rouge">http://localhost:8000</code> (or your configured URL)</li>
  <li>API documentation: <code class="language-plaintext highlighter-rouge">http://localhost:8000/api/docs/</code></li>
</ul>

<h3 id="mobile-access-with-paperless-ngx-android-app">Mobile Access with Paperless NGX Android App</h3>

<p>One of the best features of this setup is the ability to access all your documents on the go using the <a href="https://play.google.com/store/apps/details?id=de.astubenbord.paperless_mobile">Paperless Mobile app</a> by Anton Stubenbord. This is a native Android app (not just a webview) that provides an excellent mobile experience for managing your Paperless NGX documents.</p>

<p><strong>Features of the mobile app:</strong></p>
<ul>
  <li><strong>Full document access</strong>: View and search all your processed documents, including bank statements, credit card bills, and tax documents</li>
  <li><strong>Document management</strong>: Add, delete, or edit documents directly from your phone</li>
  <li><strong>Share and download</strong>: Share, download, print and preview documents</li>
  <li><strong>Scan and upload</strong>: Scan documents with your phone camera and upload them with preset correspondent, document type, tags and creation date</li>
  <li><strong>Inbox management</strong>: Review and quickly process newly added documents in the inbox</li>
  <li><strong>Security</strong>: Secure your data with biometric authentication</li>
  <li><strong>Multiple instances</strong>: Seamlessly switch between different accounts and Paperless instances</li>
  <li><strong>Modern UI</strong>: Built according to Material Design 3 specification with light and dark themes</li>
  <li><strong>Multi-language support</strong>: Available in English, German, French, Spanish, Catalan, Polish, Czech, Russian and Turkish</li>
</ul>

<p><strong>Setting up the mobile app:</strong></p>

<ol>
  <li>Install the <a href="https://play.google.com/store/apps/details?id=de.astubenbord.paperless_mobile">Paperless Mobile app</a> from Google Play Store</li>
  <li>Open the app and add your Paperless NGX server URL</li>
  <li>Log in with your credentials (or use API token authentication)</li>
  <li>Start browsing your documents!</li>
</ol>

<p>The app has a 4.6-star rating with over 50K+ downloads and provides a native mobile experience that’s much better than using the web interface on mobile.</p>

<p>Here’s a screenshot of the app showing my processed documents:</p>

<p><img src="/images/Blog/paperless-mobile-app.png" alt="" /></p>

<p>The mobile app makes it incredibly convenient to access important documents like bank statements or tax documents when you’re away from your computer. Since all documents are automatically OCR’d by Paperless NGX, you can search for specific text within documents directly from your phone.</p>

<h2 id="automation-with-systemd">Automation with Systemd</h2>

<p>To run the script daily, create a systemd timer:</p>

<h3 id="service-file-configsystemdusergmail-pdf-processorservice">Service File (<code class="language-plaintext highlighter-rouge">~/.config/systemd/user/gmail-pdf-processor.service</code>)</h3>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">Gmail PDF Processor</span>
<span class="py">After</span><span class="p">=</span><span class="s">network.target</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="s">oneshot</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="s">/usr/bin/python3 /path/to/gmail_reader.py -c /path/to/config.yaml</span>
<span class="py">WorkingDirectory</span><span class="p">=</span><span class="s">/path/to/email_reader</span>
<span class="py">StandardOutput</span><span class="p">=</span><span class="s">journal</span>
<span class="py">StandardError</span><span class="p">=</span><span class="s">journal</span>
</code></pre></div></div>

<h3 id="timer-file-configsystemdusergmail-pdf-processortimer">Timer File (<code class="language-plaintext highlighter-rouge">~/.config/systemd/user/gmail-pdf-processor.timer</code>)</h3>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="s">Run Gmail PDF Processor daily</span>
<span class="py">Requires</span><span class="p">=</span><span class="s">gmail-pdf-processor.service</span>

<span class="nn">[Timer]</span>
<span class="py">OnCalendar</span><span class="p">=</span><span class="s">daily</span>
<span class="py">OnCalendar</span><span class="p">=</span><span class="s">*-*-* 09:00:00</span>
<span class="py">Persistent</span><span class="p">=</span><span class="s">true</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="s">timers.target</span>
</code></pre></div></div>

<h3 id="enable-and-start">Enable and Start</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nt">--user</span> daemon-reload
systemctl <span class="nt">--user</span> <span class="nb">enable </span>gmail-pdf-processor.timer
systemctl <span class="nt">--user</span> start gmail-pdf-processor.timer
systemctl <span class="nt">--user</span> status gmail-pdf-processor.timer
</code></pre></div></div>

<h2 id="benefits">Benefits</h2>

<ol>
  <li><strong>Zero Manual Work</strong>: Documents are automatically extracted, decrypted, and organized</li>
  <li><strong>Searchable Archive</strong>: Paperless NGX OCRs all documents, making them fully searchable</li>
  <li><strong>Mobile Access</strong>: Access all your documents on the go with the Paperless NGX Android app</li>
  <li><strong>Backup</strong>: Documents are stored locally and optionally backed up to Google Drive</li>
  <li><strong>Notifications</strong>: Get notified about new documents via push notifications</li>
  <li><strong>Organization</strong>: Files are automatically organized by date and subject</li>
</ol>

<h2 id="security-considerations">Security Considerations</h2>

<ul>
  <li>Store your <code class="language-plaintext highlighter-rouge">config.yaml</code> with proper permissions (<code class="language-plaintext highlighter-rouge">chmod 600</code>)</li>
  <li>Use app passwords instead of your main Gmail password</li>
  <li>Keep your Paperless NGX instance behind a VPN or reverse proxy with authentication</li>
  <li>Regularly update dependencies for security patches</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>This automation has saved me countless hours of manual document management. The combination of Gmail scanning, PDF decryption, and Paperless NGX creates a seamless document management pipeline that runs completely unattended.</p>

<p>The code is modular and extensible, making it easy to add new document types or integrate with other services. Feel free to adapt it to your needs!</p>


			<footer>
				<div class="blocked tags">
					<p>
						
						<a href="/blog/tags/python">Python</a> |
						
						<a href="/blog/tags/automation">Automation</a> |
						
						<a href="/blog/tags/paperless">Paperless</a> |
						
						<a href="/blog/tags/gmail">Gmail</a> |
						
						<a href="/blog/tags/docker">Docker</a> |
						
					</p>
				</div>
			</footer>

			<br />



			<div class="hr"></div>




			<!-- Discus Comments -->
			<div id="disqus_thread"></div>

			
			<!-- Enable Disqus comments -->
			<script type="text/javascript">
  var disqus_developer = 0; // developer mode is on
  var disqus_shortname = 'madhur';
  var disqus_identifier = '/2025/12/29/automating-gmail-pdf-extraction-paperless/';
  var disqus_title = 'Automating Gmail PDF Extraction and Paperless NGX Integration';
  var disqus_url = 'https://madhur.co.in/blog/2025/12/29/automating-gmail-pdf-extraction-paperless.html';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

</script>

			




		</article>

		<div class="c">&nbsp;</div>

	</div>


</section>

<div class="c">&nbsp;</div>

        </div>


        <footer id="footer" class="row">

            <p id="copyright">
                &copy; 2011-2025 Madhur Ahuja
            </p>
            <p id="poweredby" class="visible-lg visible-md">
                Powered by
                <a href="http://jekyllrb.com" title="A static, minimalist CMS">Jekyll</a>,
                <a href="http://github.com/">Github</a> and
                <a href="http://disqus.com">Disqus</a>.
            </p>

            <div class="c">&nbsp;</div>


        </footer>


    </div>

    <script data-main="/files/js/app" src="/files/js/require.js"></script> 
    

    <!-- serviceWorker.html -->
    <script>
        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister()
                }
            })
        }

// if ('serviceWorker' in navigator) {
//     navigator.serviceWorker.register('/serviceWorker.js').then(function(reg) {
//         if (!reg.installing) return;
//         console.log("[*] ServiceWorker is installing...");

//         var worker = reg.installing;
//         worker.addEventListener('statechange', function() {
//             if (worker.state == 'redundant') {
//                 console.log('[*] Install failed');
//             }
//             if (worker.state == 'installed') {
//                 console.log('[*] Install successful!');
//             }
//         });
//     });
// }

    </script>

</body>

</html>