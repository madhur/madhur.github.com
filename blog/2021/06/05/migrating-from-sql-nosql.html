<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" /> 
    <title>Migrating from SQL to No-SQL without downtime &#8211; Madhur Ahuja</title>
    

    <meta name="author" content="Madhur Ahuja" />
    <meta name="description" content=" Migrating from SQL to No-SQL without downtime" />

    <link rel="start" href="/" />

    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur" title="RSS feed" />
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/5352cde0b084abcd6d4d783c08a51c76?s=16" />

    <link rel="stylesheet" href="/files/css/bootstrap.min.css" type="text/css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/files/font-awesome/css/font-awesome.min.css" type="text/css" />
    <script src="/files/js/vendor/fancybox.umd.js" tpye="text/javascript"></script>
    <link rel="stylesheet" href="/files/css/fancybox.css" type="text/css" />

    <link rel="stylesheet" type="text/css" href="/files/css/styles.css" /> 
    <link rel="stylesheet" type="text/css" href="/files/css/syntax.css" /> 

     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N14VDHYFHQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N14VDHYFHQ');
</script> 
    <link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css"> 

    <script src="/files/js/vendor/pace.min.js" type="text/javascript"></script>
</head>


<body>

    <div class="container">

        <header id="header" class="row">

            <nav id="navigation" class="navbar navbar-inverse navbar-fixed-top top-nav-collapse" role="navigation">
    <div class="container">

        <div class="navbar-header">

            <div class="hidden-md hidden-sm hidden-lg searchli">

                <form method="get" role="search" id="searchform" action="/results" onsubmit="return checkfrm_search();">

                    <div class="form-group">
                        <input type="search" required id="q2" name="q" value="" class="form-control mobile"
                            placeholder="Search" />
                    </div>
                </form>
            </div>

            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mainmenu">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!--  <a class="navbar-brand " href="/">Home</a> -->
        </div>

        <div class="collapse navbar-collapse" id="mainmenu">
            <ul id="nav" class="nav navbar-nav">

                <li><a class="home" href="/">Home</a>
                </li>
                <li><a class="blog" href="/blog">Blog</a>
                </li>
                <!--<li><a class="work" href="/work">Resume</a></li>-->
                <li><a class="code" href="/projects">Work</a>
                </li>
                <!--<li><a class="papers" href="/papers">Papers</a></li>-->
                <li><a class="info" href="/info">About</a>
                </li>
                <li><a class="contact" href="/contact">Contact</a>
                </li>

            </ul>

            <ul class="nav navbar-nav visible-md visible-lg visible-sm searchbox">
                <li>
                    <form method="get" role="search" id="searchform" action="/results"
                        onsubmit="return checkfrm_search();">

                        <div class="form-group">
                            <input type="search" required id="q1" name="q" value="" class="form-control desktop"
                                placeholder="Search" />
                        </div>
                    </form>
                </li>
            </ul>


            <ul class="nav-icons navbar-right nav navbar-nav visible-md visible-lg">
                <li><a href="http://www.linkedin.com/in/madhurahuja"><i class="fa fa-linkedin-square fa-3x"></i></a>
                </li>
                <li><a href="https://github.com/madhur"><i class="fa fa-github fa-3x"></i></a>
                </li>
                <li><a href="http://feeds.feedburner.com/madhur"><i class="fa fa-rss-square fa-3x"></i></a>
                </li>
            </ul>


        </div>

    </div>
</nav>

        </header>

        <div id="content" class="row">

            <section>

	<div id="blogcontent">


		<article id="blog-article" class="post col-md-12 clearfix">

			<header>
				<h1>Migrating from SQL to No-SQL without downtime</h1>
			</header>

			



<div class="post-meta">
    <time datetime="2021-06-05T00:00:00+05:30">June 05, 2021</time>
    <span class="reading-time">2 min read</span>
</div>


			<hr style="margin-top:0px" />


			<p>Recently, we migrated a large MySQL database containing GBâ€™s of data, millions of rows in few tables to CosmosDB.</p>

<p>This was done without downtime. I want to lay down the approach we took in this post.</p>

<p>Our intention was to setup both the database active - active and incrementally shift the traffic point to Service v1 (which was reading/writing to MySQL) towards 
Service v2 (which was reading/writing to CosmosDB)</p>

<p>The first challenge was doing the initial data migration (called as bootstrap) and then set up a replication pipeline (called as change feed) so that any updates/inserts/deletes
happening on live MySQL DB are replicated to CosmosDB asynchronously.</p>

<p>For this, we made use of Kafka.</p>

<ul>
  <li>
    <p>The Bootstrap process consisted of reading the table from MySQL and dumping its content into a corresponding Kafka topic. That means, we had a corresponding Kafka topic for each
table within MySQL. There are products within market such as <a href="https://www.continuent.com/products/tungsten-replicator">this</a> which can do this as well.</p>
  </li>
  <li>
    <p>The change feed process consisted of having another set of parallel kafka topics which would contain the change feed, i.e. inserts / deletes / updates happening on the MySQL database.
This was tricky because setting it up requires modifying the service layer to publish this feeds to Kafka.</p>
  </li>
</ul>

<p>The point to note above is that bootstrap is a one time process and Change feed is an ongoing process. Also, bootstrap must be executed after the change feed process is up and running, so 
as to not miss any record.</p>

<p><img src="/images/Blog/migration.png" /></p>

<p>Now comes the consumer part,
The consumer application will connect to these kafka topics and store the data in Cosmos DB. We used bulk insertion in batches of 4000 records/batch to speed up the insertions.</p>

<p>Here, the bootstrap kafka topics must be first completely consumed and written to target database before starting with ChangeFeed kafka topics.</p>

<p>As the change feed kafka topics lag becomes closer to zero (it will never be zero, since data is always being written to change feed topics), the databases are considered active active.</p>

<p>Few notes about Kafka:</p>
<ul>
  <li>
    <p>Use Kafka partitions to scale up bootstrap and consumption process horizontally. The partition key can be primary key of the table. This is especially important in change feed 
topics where multiple records will exist for same row.</p>
  </li>
  <li>
    <p>The consumer application must handle errors gracefully. If there is an error during the batch writes, the entire batch might fail.</p>
  </li>
  <li>
    <p>Use the <a href="https://en.wikipedia.org/wiki/Blue-green_deployment">blue green</a> deployment methodology</p>
  </li>
</ul>

<p>In our case, it took almost 4 hrs to complete the migration including bootstrap and change feed process for around 3 million rows in couple of tables and fewer records in other tables.</p>


			<footer>
				<div class="blocked tags">
					<p>
						
						<a href="/blog/tags/design">Design</a> |
						
					</p>
				</div>
			</footer>

			<br />



			<div class="hr"></div>

		</article>

		<div class="c">&nbsp;</div>

	</div>


</section>

<div class="c">&nbsp;</div>

        </div>


        <footer id="footer" class="row">

            <p id="copyright">
                &copy; 2011-2026 Madhur Ahuja
            </p>
            <p id="poweredby" class="visible-lg visible-md">
                Powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://github.com/">Github</a>.
            </p>

            <div class="c">&nbsp;</div>


        </footer>


    </div>

    <script src="/files/js/main.js"></script> 
    

    <!-- serviceWorker.html -->
    <script>
        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister()
                }
            })
        }

// if ('serviceWorker' in navigator) {
//     navigator.serviceWorker.register('/serviceWorker.js').then(function(reg) {
//         if (!reg.installing) return;
//         console.log("[*] ServiceWorker is installing...");

//         var worker = reg.installing;
//         worker.addEventListener('statechange', function() {
//             if (worker.state == 'redundant') {
//                 console.log('[*] Install failed');
//             }
//             if (worker.state == 'installed') {
//                 console.log('[*] Install successful!');
//             }
//         });
//     });
// }

    </script>

</body>

</html>